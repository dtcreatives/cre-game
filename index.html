<!DOCTYPE html><html lang="zh-HK"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRE 百萬富翁 - 中文運用</title>
    <style>
        /* Global Styles */
        body {
            font-family: Arial, 'Microsoft JhengHei', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #0c0c2c;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top to allow scrolling if content overflows vh */
            min-height: 100vh;
            font-size: clamp(14px, 1.5vw + 8px, 18px); /* Responsive base font size */
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
            overscroll-behavior-y: contain; /* Prevent pull-to-refresh inside app area */
        }

        #app-container {
            width: 100%;
            max-width: 900px; /* Max width for desktop */
            min-height: calc(100vh - 40px); /* Adjust if body has padding/margin */
            margin: 20px auto; /* Centering and some space from viewport edges */
            background-color: #1a1a4a;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            padding: clamp(10px, 2vw, 20px); /* Responsive padding */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            flex-grow: 1;
        }

        .screen.active {
            display: flex;
        }

        h1 {
            font-size: clamp(1.8rem, 5vw, 2.5rem); /* Responsive H1 */
            color: #ffd700;
            text-align: center;
        }
        h2 {
            font-size: clamp(1.5rem, 4vw, 2rem);   /* Responsive H2 */
            color: #ffd700;
            text-align: center;
        }
        h3 {
            font-size: clamp(1.2rem, 3vw, 1.7rem); /* Responsive H3 */
            color: #ffd700;
            text-align: center;
        }
        h4 { /* Added styling for H4 */
            font-size: clamp(1rem, 2.5vw, 1.4rem);
            color: #f0f0f0; /* Lighter than gold, but not white */
            text-align: center;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }


        button {
            background-color: #4a4a7a;
            color: #fff;
            border: 2px solid #ffd700;
            padding: clamp(10px, 1.5vh, 15px) clamp(15px, 2.5vw, 25px); /* Responsive padding */
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: clamp(0.9em, 2vw, 1.1em); /* Responsive button font size */
            transition: background-color 0.3s, transform 0.2s;
            min-height: 44px; /* Minimum tap target height */
            min-width: 44px;  /* Minimum tap target width (for icon buttons if any) */
        }
        button:hover {
            background-color: #6a6aa0;
            transform: translateY(-2px);
        }
        button:disabled {
            background-color: #333;
            color: #777;
            border-color: #555;
            cursor: not-allowed;
        }
        button:active { /* Visual feedback for tap/click */
            transform: translateY(1px) scale(0.98);
            background-color: #5a5a8a;
        }


        input[type="text"], input[type="file"] {
            padding: clamp(10px, 1.5vh, 12px);
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: calc(100% - 22px);
            max-width: 300px;
            box-sizing: border-box;
            font-size: clamp(0.9em, 2vw, 1em);
        }

        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            margin-bottom: 5px;
        }

        .spotlight-background {
            position: relative;
            overflow: hidden;
        }
        .spotlight-background::before {
            content: '';
            position: absolute;
            top: -50%;
            left: 50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(255, 255, 220, 0.15) 0%, rgba(255, 255, 220, 0.05) 30%, transparent 60%);
            transform: translateX(-50%);
            animation: spotlight-anim 15s linear infinite;
            pointer-events: none;
        }
        @keyframes spotlight-anim {
            0% { transform: translateX(-50%) rotate(0deg); }
            100% { transform: translateX(-50%) rotate(360deg); }
        }

        #screen-game {
            justify-content: space-between;
        }

        .game-top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0 clamp(5px, 1vw, 10px);
            box-sizing: border-box;
            margin-bottom: 10px;
            flex-wrap: wrap; /* Allow wrapping for smaller screens */
        }
        .lifelines {
            display: flex;
            gap: clamp(5px, 1vw, 10px); /* Spacing between lifeline buttons */
        }
        .lifelines button {
            font-size: clamp(0.8em, 1.8vw, 0.9em);
            padding: clamp(6px, 1vh, 10px) clamp(10px, 1.5vw, 15px);
        }
         .lifelines .lifeline-icon {
            margin-right: 5px;
        }
        #question-timer {
            font-size: clamp(1em, 2.2vw, 1.3em);
            color: #ffd700;
            font-weight: bold;
        }
        #current-question-info {
            font-size: clamp(0.8em, 1.8vw, 1em);
        }


        .question-area {
            background-color: rgba(0,0,50,0.7);
            padding: clamp(10px, 2vw, 20px);
            border-radius: 10px;
            margin: clamp(10px, 2vh, 20px) 0;
            width: 95%;
            text-align: center;
            border: 1px solid #ffd700;
        }
        #question-context {
            font-size: clamp(0.85em, 1.8vw, 1em);
            margin-bottom: 10px;
            text-align: left;
            white-space: pre-wrap;
            max-height: 150px; /* Keep this or adjust based on testing */
            overflow-y: auto;
            border: 1px dashed #aaa;
            padding: clamp(5px, 1vw, 10px);
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        #question-text {
            font-size: clamp(1.1em, 2.5vw, 1.4em); /* Responsive question text */
            margin-bottom: clamp(15px, 3vh, 25px);
        }
        #difficulty-indicator {
            font-style: italic;
            color: #ccc;
            margin-bottom: 10px;
            font-size: clamp(0.8em, 1.5vw, 0.9em);
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: clamp(8px, 1.5vw, 15px);
            width: 100%;
        }
        .options-grid button {
            background-color: #2a2a5a;
            width: 100%;
            min-height: clamp(50px, 8vh, 70px); /* Responsive option button height */
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: clamp(10px, 2vw, 20px);
            font-size: clamp(0.85em, 2vw, 1.05em);
        }
         .options-grid button.flashing { animation: flash-yellow 1s infinite; }
        .options-grid button.correct { background-color: green !important; animation: none !important; }
        .options-grid button.incorrect { background-color: red !important; animation: none !important; }
        .options-grid button.selected-for-audience { border: 2px solid cyan; }
        @keyframes flash-yellow {
            0%, 100% { background-color: #ffd700; color: #0c0c2c; }
            50% { background-color: #4a4a7a; color: #fff; }
        }

        .money-ladder {
            width: 200px;
            padding: clamp(5px, 1vw, 10px);
            background-color: rgba(0,0,0,0.3);
            border-radius: 5px;
            margin-left: clamp(5px, 1vw, 10px);
        }
        .money-ladder h3 { margin-top: 0; font-size: clamp(1em, 2vw, 1.2em); }
        .money-ladder ul { padding: 0; margin: 0; text-align: right; }
        .money-ladder li {
            padding: clamp(2px, 0.5vh, 4px) clamp(4px, 0.8vw, 6px);
            border-radius: 3px;
            margin-bottom: 2px;
            font-size: clamp(0.8em, 1.5vw, 0.95em);
            color: #ccc;
        }
        .money-ladder li.current-level { background-color: #ffd700; color: #0c0c2c; font-weight: bold; }
        .money-ladder li.safety-net { color: #ffeb99; font-weight: bold; }
        .money-ladder li.achieved-safety-net { background-color: #b8860b; color: white; }

        #explanation-content {
            background-color: rgba(255,255,255,0.1);
            padding: clamp(10px, 2vw, 15px);
            border-radius: 5px;
            margin: clamp(15px, 2vh, 20px) 0;
            max-width: 80%;
            text-align: left;
            white-space: pre-wrap;
            font-size: clamp(0.9em, 1.8vw, 1em);
        }

        .stats-content-wrapper {
            max-height: 60vh;
            overflow-y: auto;
            width: 100%;
            padding-right: clamp(5px, 1vw, 10px);
            box-sizing: border-box;
            margin-bottom: 10px;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        #stats-recommendations p {
            margin: clamp(6px, 1vh, 10px) 0;
            font-size: clamp(0.9em, 1.8vw, 1em);
        }

        /* Wrapper for tables to make them horizontally scrollable on small screens */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 15px; /* Space below the scrollable table */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling for table wrapper */
        }
        .stats-table, .history-table, .leaderboard-table {
            width: 100%; /* Make table take full width of its wrapper */
            min-width: 500px; /* Set a min-width so it doesn't collapse too much */
            margin-top: 15px;
            border-collapse: collapse;
        }
        .stats-table th, .stats-table td,
        .history-table th, .history-table td,
        .leaderboard-table th, .leaderboard-table td {
            border: 1px solid #ffd700;
            padding: clamp(6px, 1vw, 10px);
            text-align: left;
            font-size: clamp(0.8em, 1.5vw, 0.95em);
        }
        .stats-table th, .history-table th, .leaderboard-table th {
            background-color: #4a4a7a;
        }

        /* Custom scrollbar for webkit browsers (optional aesthetics) */
        #question-context::-webkit-scrollbar,
        .stats-content-wrapper::-webkit-scrollbar,
        .table-wrapper::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* For horizontal scrollbar */
        }
        #question-context::-webkit-scrollbar-thumb,
        .stats-content-wrapper::-webkit-scrollbar-thumb,
        .table-wrapper::-webkit-scrollbar-thumb {
            background-color: #ffd700;
            border-radius: 4px;
        }
        #question-context::-webkit-scrollbar-track,
        .stats-content-wrapper::-webkit-scrollbar-track,
        .table-wrapper::-webkit-scrollbar-track {
            background-color: rgba(0,0,0,0.2);
        }

        /* For Firefox scrollbar styling (optional aesthetics) */
        #question-context,
        .stats-content-wrapper,
        .table-wrapper {
            scrollbar-width: thin;
            scrollbar-color: #ffd700 rgba(0,0,0,0.2);
        }


        @media (max-width: 768px) {
            body {
                font-size: clamp(13px, 1.8vw + 7px, 16px); /* Slightly smaller base for mobile */
                align-items: stretch; /* Allow app container to define its height */
            }
            #app-container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh; /* Full viewport height on mobile */
                padding: 10px;
            }

            .game-top-bar {
                flex-direction: column;
                align-items: center;
                gap: 10px; /* Space between elements when stacked */
            }
            .lifelines {
                order: 2; /* Move lifelines below timer/info on mobile stack */
                width: 100%;
                justify-content: space-around;
            }
            #question-timer { order: 1; margin-top: 0; }
            #current-question-info { order: 0; }


            .options-grid {
                grid-template-columns: 1fr;
            }
            .game-screen-layout {
                flex-direction: column-reverse;
                align-items: center;
            }
            .money-ladder {
                width: 100%; /* Full width on mobile */
                margin-left: 0;
                margin-bottom: 15px;
                text-align: center;
                max-height: 15vh; /* Limit height and make it scrollable if needed */
                overflow-y: auto; /* Allow scrolling for money ladder if it gets too tall */
            }
            .money-ladder ul {
                text-align: center;
                display: flex; /* Allows wrapping and centering */
                flex-wrap: wrap;
                justify-content: center;
            }
            .money-ladder li {
                display: inline-block;
                margin: 2px 4px; /* Adjust spacing for wrapped items */
                padding: 4px 8px;
                font-size: 0.85em;
            }

            .stats-content-wrapper {
                max-height: 70vh;
            }
        }

        @media (max-width: 480px) { /* Even smaller screens */
            h1 { font-size: clamp(1.6rem, 7vw, 2rem); } /* Adjusted vw for more impact */
            h2 { font-size: clamp(1.3rem, 6vw, 1.7rem); }
            h3 { font-size: clamp(1.1rem, 5vw, 1.5rem); }
            h4 { font-size: clamp(0.9rem, 4vw, 1.2rem); }

            button {
                padding: clamp(10px, 1.8vh, 14px) clamp(12px, 2.5vw, 22px); /* Slightly more vertical padding */
                font-size: clamp(0.85em, 2.5vw, 1em);
            }
            .options-grid button {
                min-height: clamp(48px, 7.5vh, 65px);
                font-size: clamp(0.8em, 2.2vw, 1em);
            }
            .lifelines button {
                flex-basis: calc(33.33% - 10px); /* Try to fit 3 in a row, or they wrap */
                font-size: clamp(0.75em, 1.8vw, 0.85em);
            }
            #question-text {
                font-size: clamp(1em, 3vw, 1.3em);
            }
        }


        .milestone-celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 215, 0, 0.9);
            color: #0c0c2c;
            padding: 30px;
            border-radius: 10px;
            font-size: clamp(1.5em, 4vw, 2.2em); /* Responsive celebration text */
            text-align: center;
            z-index: 1000;
            display: none;
            animation: fadeInOut 3s ease-in-out;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20%, 80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

    </style>
</head>
<body class="spotlight-background">
    <div id="app-container">
        <!-- Username Screen -->
        <div id="screen-username" class="screen active">
            <h1>CRE 百萬富翁 - 中文運用</h1>
            <h2>歡迎! 請輸入用戶名 (3-20 字元)</h2>
            <input type="text" id="username-input" placeholder="用戶名">
            <button id="register-login-btn">註冊 / 登入</button>
            <p id="username-error" style="color: red;"></p>
            <p id="auto-csv-status" style="margin-top: 10px;"></p>

            <div id="data-management-area" style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 15px; width:100%; text-align:center;">
                <h3>遊戲進度管理</h3>
                <button id="export-data-btn" style="background-color: #306754;">導出此用戶進度</button>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
                <button id="import-data-btn" style="background-color: #673030;">導入用戶進度</button>
                <p id="data-management-status" style="margin-top: 10px;"></p>
            </div>
        </div>

        <!-- Main Menu Screen -->
        <div id="screen-main-menu" class="screen">
            <h1>主目錄</h1>
            <h2 id="welcome-user-text"></h2>
            <button id="new-game-btn">開始新遊戲</button>
            <button id="progress-stats-btn">進度統計</button>
            <button id="game-history-btn">遊戲記錄</button>
            <button id="leaderboard-btn">排行榜</button>
            <button id="logout-btn">登出</button>
        </div>

        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="game-top-bar">
                <div id="current-question-info">問題 1 / 15</div>
                <div id="question-timer">01:00</div>
                <div class="lifelines">
                    <button id="lifeline-5050" data-used="false"><span class="lifeline-icon">½</span> 50:50</button>
                    <button id="lifeline-phone" data-used="false"><span class="lifeline-icon">📞</span> 致電好友</button>
                    <button id="lifeline-audience" data-used="false"><span class="lifeline-icon">📊</span> 觀眾投票</button>
                </div>
            </div>

            <div class="game-screen-layout" style="display: flex; width: 100%; flex-grow: 1;">
                <div class="question-options-area" style="flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <div class="question-area">
                        <div id="difficulty-indicator"></div>
                        <div id="question-context"></div>
                        <div id="question-text"></div>
                    </div>
                    <div class="options-grid">
                        <button id="optionA-btn" data-option="A"></button>
                        <button id="optionB-btn" data-option="B"></button>
                        <button id="optionC-btn" data-option="C"></button>
                        <button id="optionD-btn" data-option="D"></button>
                    </div>
                </div>
                <div class="money-ladder" id="money-ladder-display">
                    <h3>獎金階梯</h3>
                    <ul></ul>
                </div>
            </div>

            <div class="game-controls" style="margin-top: auto; text-align: center; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px;">
                <button id="walk-away-btn">放棄並取走獎金</button>
                <button id="quit-to-menu-btn" style="background-color: #8B0000;">離開遊戲返回主目錄</button>
            </div>
        </div>

        <!-- Explanation Screen -->
        <div id="screen-explanation" class="screen">
            <h2 id="explanation-title"></h2>
            <p id="explanation-question"></p>
            <p>你的答案: <span id="explanation-your-answer"></span></p>
            <p>正確答案: <span id="explanation-correct-answer"></span></p>
            <h3>解釋:</h3>
            <div id="explanation-content"></div>
            <button id="explanation-continue-btn">繼續</button>
        </div>

        <!-- Game Over Screen -->
        <div id="screen-game-over" class="screen">
            <h1 id="game-over-title">遊戲結束</h1>
            <p id="game-over-message"></p>
            <p>你獲得的獎金: $<span id="game-over-winnings"></span></p>
            <button id="game-over-tomainmenu-btn">返回主目錄</button>
        </div>

        <!-- Progress Stats Screen -->
        <div id="screen-stats" class="screen">
            <h1>進度統計</h1>
            <div class="stats-content-wrapper">
                <h3 id="stats-username"></h3>
                <h4>整體表現:</h4>
                <p>總遊戲次數: <span id="stats-total-games"></span></p>
                <p>總勝出次數 (百萬富翁): <span id="stats-total-wins"></span></p>
                <p>平均每局答對題數: <span id="stats-avg-correct"></span></p>
                <p>最長連勝紀錄: <span id="stats-longest-streak"></span></p>

                <h4>按類別表現:</h4>
                <div class="table-wrapper">
                    <table id="stats-category-table" class="stats-table">
                        <thead><tr><th>類別</th><th>已嘗試</th><th>答對</th><th>正確率</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <h4>按難度表現:</h4>
                <div class="table-wrapper">
                    <table id="stats-difficulty-table" class="stats-table">
                        <thead><tr><th>難度</th><th>已嘗試</th><th>答對</th><th>正確率</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <h4>學習建議:</h4>
                <div id="stats-recommendations"></div>

                <h4>成就:</h4>
                <ul id="stats-achievements-list"></ul>
            </div>
            <button class="back-to-menu-btn">返回主目錄</button>
        </div>

        <!-- Game History Screen -->
        <div id="screen-history" class="screen">
            <h1>遊戲記錄</h1>
            <div class="stats-content-wrapper">
                <div class="table-wrapper">
                    <table id="history-table" class="history-table">
                        <thead><tr><th>日期</th><th>狀態</th><th>答對題數</th><th>獎金</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <button class="back-to-menu-btn">返回主目錄</button>
        </div>

        <!-- Leaderboard Screen -->
        <div id="screen-leaderboard" class="screen">
            <h1>排行榜 (最高獎金)</h1>
            <div class="stats-content-wrapper">
                <div class="table-wrapper">
                    <table id="leaderboard-table" class="leaderboard-table">
                        <thead><tr><th>排名</th><th>用戶名</th><th>獎金</th><th>日期</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <button class="back-to-menu-btn">返回主目錄</button>
        </div>

        <!-- Milestone Celebration Popup -->
        <div id="milestone-celebration" class="milestone-celebration">
            <p id="milestone-text"></p>
        </div>

    </div>

    <script>
        // --- Constants and Global State ---
        const LS_USERS_KEY = 'crem_users';
        const LS_GLOBAL_STATS_KEY = 'crem_globalStats';

        const PRIZE_MONEY = [0, 1000, 2000, 3000, 5000, 10000, 20000, 40000, 80000, 160000, 320000, 450000, 600000, 750000, 850000, 1000000];
        const SAFETY_NET_1_LEVEL = 5;
        const SAFETY_NET_2_LEVEL = 10;
        const TOTAL_QUESTIONS_PER_GAME = 15;
        const QUESTION_TIME_LIMIT = 60; // seconds

        const QUESTION_CATEGORIES = ["片段/語段閱讀", "片段閱讀", "字詞辨識", "句子辨析", "詞句運用"];
        const QUESTION_DIFFICULTIES = ["easy", "medium", "hard"];

        const MIN_ATTEMPTS_FOR_ADVICE = 5;
        const WEAKNESS_ACCURACY_THRESHOLD = 0.60;
        const STRENGTH_ACCURACY_THRESHOLD = 0.85;


        let allQuestions = [];
        let currentUser = null;
        let currentUsername = '';

        let gameQuestions = [];
        let currentQuestionNumber = 0;
        let currentMoney = 0;
        let currentLifelines = { fiftyFifty: false, phoneAFriend: false, askTheAudience: false };
        let questionsAnsweredCorrectlyInGame = 0;
        let safetyNet1Achieved = false;
        let safetyNet2Achieved = false;
        let currentStreakInGame = 0;
        let gameAttemptData = {};
        let questionStartTime;
        let questionTimerInterval = null;
        let timeLeft = QUESTION_TIME_LIMIT;


        // --- DOM Elements ---
        const screens = {
            username: document.getElementById('screen-username'),
            mainMenu: document.getElementById('screen-main-menu'),
            game: document.getElementById('screen-game'),
            explanation: document.getElementById('screen-explanation'),
            gameOver: document.getElementById('screen-game-over'),
            stats: document.getElementById('screen-stats'),
            history: document.getElementById('screen-history'),
            leaderboard: document.getElementById('screen-leaderboard'),
        };

        const usernameInput = document.getElementById('username-input');
        const registerLoginBtn = document.getElementById('register-login-btn');
        const usernameError = document.getElementById('username-error');
        const autoCsvStatusP = document.getElementById('auto-csv-status');

        const exportDataBtn = document.getElementById('export-data-btn');
        const importFileInput = document.getElementById('import-file-input');
        const importDataBtn = document.getElementById('import-data-btn');
        const dataManagementStatus = document.getElementById('data-management-status');

        const welcomeUserText = document.getElementById('welcome-user-text');
        const newGameBtn = document.getElementById('new-game-btn');
        const progressStatsBtn = document.getElementById('progress-stats-btn');
        const gameHistoryBtn = document.getElementById('game-history-btn');
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const logoutBtn = document.getElementById('logout-btn');

        const lifeline5050Btn = document.getElementById('lifeline-5050');
        const lifelinePhoneBtn = document.getElementById('lifeline-phone');
        const lifelineAudienceBtn = document.getElementById('lifeline-audience');
        const currentQuestionInfo = document.getElementById('current-question-info');
        const questionTimerDisplay = document.getElementById('question-timer');
        const difficultyIndicator = document.getElementById('difficulty-indicator');
        const questionContext = document.getElementById('question-context');
        const questionText = document.getElementById('question-text');
        const optionABtn = document.getElementById('optionA-btn');
        const optionBBtn = document.getElementById('optionB-btn');
        const optionCBtn = document.getElementById('optionC-btn');
        const optionDBtn = document.getElementById('optionD-btn');
        const optionButtons = [optionABtn, optionBBtn, optionCBtn, optionDBtn];
        const moneyLadderDisplay = document.getElementById('money-ladder-display').querySelector('ul');
        const walkAwayBtn = document.getElementById('walk-away-btn');
        const quitToMenuBtn = document.getElementById('quit-to-menu-btn');


        const explanationTitle = document.getElementById('explanation-title');
        const explanationQuestion = document.getElementById('explanation-question');
        const explanationYourAnswer = document.getElementById('explanation-your-answer');
        const explanationCorrectAnswer = document.getElementById('explanation-correct-answer');
        const explanationContent = document.getElementById('explanation-content');
        const explanationContinueBtn = document.getElementById('explanation-continue-btn');

        const gameOverTitle = document.getElementById('game-over-title');
        const gameOverMessage = document.getElementById('game-over-message');
        const gameOverWinnings = document.getElementById('game-over-winnings');
        const gameOverToMainMenuBtn = document.getElementById('game-over-tomainmenu-btn');

        const statsUsername = document.getElementById('stats-username');
        const statsTotalGames = document.getElementById('stats-total-games');
        const statsTotalWins = document.getElementById('stats-total-wins');
        const statsAvgCorrect = document.getElementById('stats-avg-correct');
        const statsLongestStreak = document.getElementById('stats-longest-streak');
        const statsCategoryTableBody = document.getElementById('stats-category-table').querySelector('tbody');
        const statsDifficultyTableBody = document.getElementById('stats-difficulty-table').querySelector('tbody');
        const statsRecommendations = document.getElementById('stats-recommendations');
        const statsAchievementsList = document.getElementById('stats-achievements-list');
        const historyTableBody = document.getElementById('history-table').querySelector('tbody');
        const leaderboardTableBody = document.getElementById('leaderboard-table').querySelector('tbody');
        const milestoneCelebrationDiv = document.getElementById('milestone-celebration');
        const milestoneText = document.getElementById('milestone-text');


        // --- Utility Functions ---
        function showScreen(screenId) {
            for (const key in screens) screens[key].classList.remove('active');
            if (screens[screenId]) screens[screenId].classList.add('active');
            else console.error("畫面未找到:", screenId);
        }
        function getLocalStorageItem(key, defaultValue = {}) {
            const item = localStorage.getItem(key);
            try { return item ? JSON.parse(item) : defaultValue; }
            catch (e) { console.warn(`解析 localStorage 項目 ${key} 時出錯:`, e); return defaultValue; }
        }
        function setLocalStorageItem(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
        function formatCurrency(amount) { return amount.toLocaleString(); }
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        function escapeHTML(text) {
            if (typeof text !== 'string') { console.warn("escapeHTML called with non-string value:", text); return String(text); }
            let element = document.createElement('a'); element.textContent = text; return element.innerHTML;
        }

        // --- User Management ---
        function loadUsers() { return getLocalStorageItem(LS_USERS_KEY, {}); }
        function saveUsers(users) { setLocalStorageItem(LS_USERS_KEY, users); }
        function initializeUser(username) {
            const userProgress = {
                overallDifficulty: { easy: {correct:0, total:0}, medium: {correct:0, total:0}, hard: {correct:0, total:0} },
                questionStats: {}
            };
            QUESTION_CATEGORIES.forEach(cat => {
                userProgress[cat] = { easy: {correct:0, total:0}, medium: {correct:0, total:0}, hard: {correct:0, total:0} };
            });
            return {
                username: username, gameAttempts: [], progress: userProgress,
                achievements: initializeAchievements(),
                lifelineStats: { fiftyFifty: { used: 0, successfulUse: 0 }, phoneAFriend: { used: 0, successfulUse: 0 }, askTheAudience: { used: 0, successfulUse: 0 }},
                longestStreak: 0, preferences: {}
            };
        }
        function initializeAchievements() {
            return { "新手上路": false, "初試啼聲": false, "萬元戶": false, "十萬元戶": false, "百萬富翁": false, "智囊團": false, "連勝將軍": false, "時間管理大師": false };
        }
        function handleRegisterLogin() {
            const username = usernameInput.value.trim(); usernameError.textContent = '';
            if (username.length < 3 || username.length > 20) { usernameError.textContent = '用戶名必須為 3-20 個字元。'; return; }
            if (!/^[a-zA-Z0-9_]+$/.test(username)) { usernameError.textContent = '用戶名只能包含字母、數字和底線。'; return; }
            if (allQuestions.length === 0) {
                autoCsvStatusP.textContent = '錯誤：遊戲題目未能成功載入，無法開始遊戲。'; autoCsvStatusP.style.color = 'red';
                alert('錯誤：遊戲題目未能成功載入，無法開始遊戲。請刷新頁面或稍後再試。'); registerLoginBtn.disabled = true; return;
            }
            const users = loadUsers();
            if (!users[username]) users[username] = initializeUser(username);
            currentUser = users[username]; currentUsername = username;
            if (currentUser.progress && typeof currentUser.progress.questionStats === 'undefined') currentUser.progress.questionStats = {};
            saveUsers(users);
            welcomeUserText.textContent = `歡迎, ${currentUsername}!`; showScreen('mainMenu');
        }

        function confirmQuitAndOfferExport(actionAfterConfirm) {
            const gameScreenActive = screens.game.classList.contains('active');
            const inMiddleOfGame = currentQuestionNumber > 0 && currentQuestionNumber <= TOTAL_QUESTIONS_PER_GAME && gameQuestions.length > 0;

            if (gameScreenActive && inMiddleOfGame) {
                if (confirm("您確定要結束目前的遊戲嗎？您的遊戲進度將會像「放棄」一樣被記錄下來。\n\n您是否也想導出您的整體遊戲進度到檔案中？")) {
                    handleWalkAway(false); 
                    exportGameData();    
                    actionAfterConfirm(); 
                } else if (confirm("您確定要結束目前的遊戲嗎？（不導出檔案）")) {
                    handleWalkAway(false); 
                    actionAfterConfirm(); 
                }
            } else {
                actionAfterConfirm(); 
            }
        }

        function handleLogout() {
            confirmQuitAndOfferExport(() => {
                if (currentUser) {
                    const users = loadUsers(); users[currentUsername] = currentUser; saveUsers(users);
                }
                currentUser = null; currentUsername = ''; usernameInput.value = '';
                showScreen('username');
                currentQuestionNumber = 0; gameQuestions = []; 
            });
        }


        // --- CSV Management ---
        const csvStatus = {
            log: function(message, type = 'info') {
                console.log(`CSV 狀態 (${type}): ${message}`); let color = 'blue';
                if (type === 'error') color = 'red'; else if (type === 'success') color = 'green';
                if (autoCsvStatusP) { autoCsvStatusP.textContent = message; autoCsvStatusP.style.color = color; }
            }
        };
        function parseCSV(csvText) {
            if (csvText.charCodeAt(0) === 0xFEFF) csvText = csvText.substring(1);
            const lines = csvText.split(/\r\n|\n/); if (lines.length === 0) return [];
            const headers = lines[0].split(',').map(h => h.trim()); const questions = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim(); if (line === '') continue;
                const fields = []; let currentField = ''; let inQuotes = false; let quoteChar = '';
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (!inQuotes && (char === '"' || char === "'")) { inQuotes = true; quoteChar = char; }
                    else if (inQuotes && char === quoteChar) {
                        if (j + 1 < line.length && line[j + 1] === quoteChar) { currentField += quoteChar; j++; }
                        else { inQuotes = false; }
                    } else if (char === ',' && !inQuotes) { fields.push(currentField.trim()); currentField = ''; }
                    else { currentField += char; }
                }
                fields.push(currentField.trim());
                if (fields.length !== headers.length) { csvStatus.log(`警告: CSV 第 ${i+1} 行欄位數量不符 (${fields.length} vs ${headers.length})，已跳過。`, 'error'); continue; }
                const question = {}; headers.forEach((header, index) => { question[header] = fields[index]; });
                if (!question.id || !question.category || !question.difficulty || !question.question || !question.optionA || !question.optionB || !question.optionC || !question.optionD || !question.correct || !question.explanation) {
                    csvStatus.log(`警告: CSV 第 ${i+1} 行 (ID: ${question.id || 'N/A'}) 缺少必要欄位，已跳過。`, 'error'); continue;
                }
                if (question.difficulty && !QUESTION_DIFFICULTIES.includes(question.difficulty.toLowerCase())) {
                    csvStatus.log(`警告: CSV 第 ${i+1} 行 (ID: ${question.id}) 難度 "${question.difficulty}" 無效。`, 'error'); continue;
                }
                questions.push(question);
            }
            return questions;
        }
        async function loadQuestionsFromHostedCSV(filePath) {
            try {
                csvStatus.log('正在從伺服器載入題目...', 'info');
                const response = await fetch(filePath);
                if (!response.ok) throw new Error(`無法獲取題目檔案: ${response.status} ${response.statusText}`);
                const csvText = await response.text(); const parsedQuestions = parseCSV(csvText);
                if (parsedQuestions.length > 0) {
                    allQuestions = parsedQuestions;
                    csvStatus.log(`成功載入 ${allQuestions.length} 條題目。遊戲已準備就緒！`, 'success'); return true;
                } else { csvStatus.log('題目檔案為空或格式不正確。無法開始遊戲。', 'error'); return false; }
            } catch (error) {
                csvStatus.log(`載入題目時出錯: ${error.message}。無法開始遊戲。`, 'error');
                console.error("載入題目 CSV 時出錯:", error); return false;
            }
        }

        // --- Data Import/Export Functions ---
        function exportGameData() {
            dataManagementStatus.textContent = ''; const usernameToExport = usernameInput.value.trim();
            if (!usernameToExport) { dataManagementStatus.textContent = "請在用戶名欄位中輸入要導出的用戶名。"; dataManagementStatus.style.color = "orange"; return; }
            const allUsers = loadUsers(); const userDataToExport = allUsers[usernameToExport];
            if (!userDataToExport) { dataManagementStatus.textContent = `在本地存儲中找不到用戶 "${usernameToExport}" 的數據。`; dataManagementStatus.style.color = "red"; return; }
            const dataToExport = { appVersion: "CRE_Millionaire_User_1.2", exportedAt: new Date().toISOString(), username: usernameToExport, userData: userDataToExport };
            const jsonString = JSON.stringify(dataToExport, null, 2); const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement("a"); const filename = `cre_millionaire_progress_${usernameToExport}.json`;
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", filename);
                link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
                dataManagementStatus.textContent = `用戶 ${usernameToExport} 的遊戲進度已導出為 ${filename}。`; dataManagementStatus.style.color = 'green';
            } else { dataManagementStatus.textContent = "您的瀏覽器不支持自動下載。"; dataManagementStatus.style.color = 'red'; }
        }
        function handleImportFile(event) {
            dataManagementStatus.textContent = ''; const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedContainer = JSON.parse(e.target.result);
                        if (!importedContainer || typeof importedContainer !== 'object' || !importedContainer.userData || !importedContainer.username) {
                            throw new Error("無效的用戶存檔檔案格式：缺少 'userData' 或 'username'。");
                        }
                        const importedUsername = importedContainer.username; const importedUserData = importedContainer.userData;
                        if (importedUserData.progress && typeof importedUserData.progress.questionStats === 'undefined') importedUserData.progress.questionStats = {};
                        const allUsersData = loadUsers(); allUsersData[importedUsername] = importedUserData; saveUsers(allUsersData);
                        dataManagementStatus.textContent = `用戶 ${importedUsername} 的遊戲進度已成功導入！`; dataManagementStatus.style.color = 'green';
                        if (!currentUser || currentUsername === importedUsername) {
                            currentUsername = importedUsername; currentUser = importedUserData;
                            if (screens.mainMenu.classList.contains('active') || screens.username.classList.contains('active')) {
                                 welcomeUserText.textContent = `歡迎, ${currentUsername}! (進度已導入)`;
                                 if (screens.username.classList.contains('active')) showScreen('mainMenu');
                            }
                        } else {
                            alert(`用戶 ${importedUsername} 的數據已導入。\n您當前登入為 ${currentUsername}。\n如要使用 ${importedUsername} 的數據，請先登出，然後以 ${importedUsername} 登入。`);
                        }
                        if (!currentUser && allUsersData[importedUsername]) usernameInput.value = importedUsername;
                        importFileInput.value = null;
                    } catch (error) {
                        dataManagementStatus.textContent = `導入用戶存檔檔案時出錯: ${error.message}`; dataManagementStatus.style.color = 'red';
                        console.error("導入用戶遊戲數據時出錯:", error); importFileInput.value = null;
                    }
                };
                reader.onerror = function() { dataManagementStatus.textContent = '讀取檔案失敗。'; dataManagementStatus.style.color = 'red'; importFileInput.value = null; };
                reader.readAsText(file);
            } else { dataManagementStatus.textContent = "未選擇檔案。"; dataManagementStatus.style.color = "orange"; }
        }

        // --- Game Logic ---
        function startQuestionTimer() {
            stopQuestionTimer(); timeLeft = QUESTION_TIME_LIMIT;
            questionTimerDisplay.textContent = formatTime(timeLeft); questionTimerDisplay.style.color = '#ffd700';
            questionTimerInterval = setInterval(() => {
                timeLeft--; questionTimerDisplay.textContent = formatTime(timeLeft);
                if (timeLeft <= 10 && timeLeft > 0) questionTimerDisplay.style.color = 'red';
                if (timeLeft <= 0) handleAnswer('TIMEOUT');
            }, 1000);
        }
        function stopQuestionTimer() { if (questionTimerInterval) clearInterval(questionTimerInterval); questionTimerInterval = null; }
        function selectGameQuestions() {
            const easyQs = allQuestions.filter(q => q.difficulty.toLowerCase() === 'easy');
            const mediumQs = allQuestions.filter(q => q.difficulty.toLowerCase() === 'medium');
            const hardQs = allQuestions.filter(q => q.difficulty.toLowerCase() === 'hard');
            if (easyQs.length < 5 || mediumQs.length < 5 || hardQs.length < 5) { csvStatus.log("題目數量不足 (每種難度至少5條)", "error"); return false; }
            gameQuestions = [ ...easyQs.sort(() => 0.5 - Math.random()).slice(0, 5), ...mediumQs.sort(() => 0.5 - Math.random()).slice(0, 5), ...hardQs.sort(() => 0.5 - Math.random()).slice(0, 5) ];
            for (let i = gameQuestions.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [gameQuestions[i], gameQuestions[j]] = [gameQuestions[j], gameQuestions[i]]; }
            return true;
        }
        function startNewGame() {
            if (!selectGameQuestions()) { showScreen('mainMenu'); return; }
            currentQuestionNumber = 0; currentMoney = 0; questionsAnsweredCorrectlyInGame = 0;
            safetyNet1Achieved = false; safetyNet2Achieved = false; currentStreakInGame = 0;
            currentLifelines = { fiftyFifty: false, phoneAFriend: false, askTheAudience: false }; updateLifelineButtons();
            gameAttemptData = { id: `game_${Date.now()}`, date: new Date().toISOString(), status: 'quit', questionsAnswered: 0, moneyWon: 0, lifelinesUsed: { fiftyFifty: false, phoneAFriend: false, askTheAudience: false }, answers: [] };
            if (currentUser && !currentUser.achievements["新手上路"]) { currentUser.achievements["新手上路"] = true; checkAndNotifyAchievement("新手上路"); }
            nextQuestion(); 
            // showScreen('game'); // nextQuestion will call displayQuestion which should show the game screen if needed
        }
        function updateMoneyLadder() {
            moneyLadderDisplay.innerHTML = '';
            for (let i = TOTAL_QUESTIONS_PER_GAME; i >= 1; i--) {
                const li = document.createElement('li'); li.textContent = `Q${i}: $${formatCurrency(PRIZE_MONEY[i])}`;
                if (i === questionsAnsweredCorrectlyInGame + 1 && currentQuestionNumber > 0 && currentQuestionNumber <= TOTAL_QUESTIONS_PER_GAME) li.classList.add('current-level');
                if (i === SAFETY_NET_1_LEVEL || i === SAFETY_NET_2_LEVEL) {
                    li.classList.add('safety-net');
                    if ((i === SAFETY_NET_1_LEVEL && safetyNet1Achieved) || (i === SAFETY_NET_2_LEVEL && safetyNet2Achieved)) li.classList.add('achieved-safety-net');
                }
                moneyLadderDisplay.appendChild(li);
            }
        }
        function displayQuestion() {
            const q = gameQuestions[currentQuestionNumber - 1]; if (!q) { endGame('error'); return; }
            questionStartTime = Date.now(); startQuestionTimer();
            currentQuestionInfo.textContent = `問題 ${currentQuestionNumber} / ${TOTAL_QUESTIONS_PER_GAME}`;
            difficultyIndicator.textContent = `難度: ${q.difficulty}`;
            questionContext.textContent = q.context || ''; questionContext.style.display = q.context ? 'block' : 'none';
            questionText.textContent = q.question;
            const options = [q.optionA, q.optionB, q.optionC, q.optionD];
            optionButtons.forEach((btn, index) => {
                const optionChar = String.fromCharCode(65 + index);
                btn.innerHTML = `<span style="color: #ffd700; margin-right: 8px;">${optionChar}:</span> ${options[index]}`;
                btn.dataset.option = optionChar; btn.disabled = false; btn.style.visibility = 'visible';
                btn.classList.remove('correct', 'incorrect', 'flashing', 'selected-for-audience');
            });
            updateMoneyLadder(); walkAwayBtn.disabled = (currentQuestionNumber === 1 && questionsAnsweredCorrectlyInGame === 0);
            showScreen('game'); // Ensure game screen is active when a question is displayed
        }
        
        function handleAnswer(selectedOption) {
            stopQuestionTimer(); optionButtons.forEach(btn => btn.disabled = true); walkAwayBtn.disabled = true;
            const question = gameQuestions[currentQuestionNumber - 1]; const correctAnswer = question.correct.toUpperCase();
            const timeTaken = (Date.now() - questionStartTime) / 1000;
            if (!gameAttemptData.answers) gameAttemptData.answers = [];
            gameAttemptData.answers.push({ questionId: question.id, selected: selectedOption, correct: correctAnswer, timeTaken: timeTaken });
            let isCorrect = (selectedOption === correctAnswer); if (selectedOption === 'TIMEOUT') isCorrect = false;

            if (currentUser && currentUser.progress && question.id) {
                if (typeof currentUser.progress.questionStats === 'undefined') currentUser.progress.questionStats = {};
                if (!currentUser.progress.questionStats[question.id]) currentUser.progress.questionStats[question.id] = { correct: 0, incorrect: 0, seen: 0 };
                currentUser.progress.questionStats[question.id].seen++;
                if (isCorrect) currentUser.progress.questionStats[question.id].correct++;
                else currentUser.progress.questionStats[question.id].incorrect++;
            }

            optionButtons.forEach(btn => {
                if (btn.dataset.option === selectedOption) btn.classList.add(isCorrect ? 'correct' : 'incorrect');
                if (btn.dataset.option === correctAnswer) {
                    if(!isCorrect && selectedOption !== 'TIMEOUT') btn.classList.add('flashing');
                    else if (isCorrect) btn.classList.add('correct');
                }
            });

            if (currentUser && selectedOption !== 'TIMEOUT') {
                const cat = question.category; const diff = question.difficulty.toLowerCase();
                if (!currentUser.progress[cat]) currentUser.progress[cat] = { easy: {correct:0, total:0}, medium: {correct:0, total:0}, hard: {correct:0, total:0} };
                if (!currentUser.progress[cat][diff]) currentUser.progress[cat][diff] = {correct:0, total:0};
                currentUser.progress[cat][diff].total++; currentUser.progress.overallDifficulty[diff].total++;
                if (isCorrect) {
                    currentUser.progress[cat][diff].correct++; currentUser.progress.overallDifficulty[diff].correct++;
                    if (timeLeft > 0 && !currentUser.achievements["時間管理大師"]) { currentUser.achievements["時間管理大師"] = true; checkAndNotifyAchievement("時間管理大師");}
                }
            }
            setTimeout(() => { showExplanationScreen(question, selectedOption, isCorrect); }, 2000);
        }

        function showExplanationScreen(question, selectedOption, isCorrect) {
            stopQuestionTimer(); 
            explanationTitle.textContent = isCorrect ? "答對了!" : (selectedOption === 'TIMEOUT' ? "時間到了!" : "答錯了!");
            explanationTitle.style.color = isCorrect ? "lightgreen" : "salmon";
            explanationQuestion.textContent = `問題: ${question.question}`;
            let yourAnswerText = '未作答 (時間到)';
            if (selectedOption !== 'TIMEOUT' && question['option' + selectedOption]) {
                yourAnswerText = `${selectedOption} (${question['option'+selectedOption]})`;
            } else if (selectedOption !== 'TIMEOUT' && selectedOption) { 
                yourAnswerText = `${selectedOption} (選項無效或未提供)`;
            } else if (selectedOption !== 'TIMEOUT' && !selectedOption) {
                 yourAnswerText = `未選擇答案`;
            }
            explanationYourAnswer.textContent = yourAnswerText;
            explanationCorrectAnswer.textContent = `${question.correct} (${question['option'+question.correct]})`;
            explanationContent.innerHTML = question.explanation ? question.explanation.replace(/\\n/g, '<br>') : "沒有提供解釋。";
            
            explanationContinueBtn.onclick = () => { // This is the critical part
                if (isCorrect) {
                    handleCorrectAnswer(); 
                } else {
                    handleIncorrectAnswer(); 
                }
            };
            showScreen('explanation');
        }

        function nextQuestion() {
            currentQuestionNumber++; 
            // No win check here, handleCorrectAnswer does it.
            displayQuestion();
        }


        function handleCorrectAnswer() {
            questionsAnsweredCorrectlyInGame++; currentStreakInGame++;
            if (currentUser && currentStreakInGame > currentUser.longestStreak) currentUser.longestStreak = currentStreakInGame;
            if (currentUser && !currentUser.achievements["初試啼聲"] && questionsAnsweredCorrectlyInGame >= 1) { currentUser.achievements["初試啼聲"] = true; checkAndNotifyAchievement("初試啼聲"); }
            if (currentUser && currentStreakInGame >= 5 && !currentUser.achievements["連勝將軍"]) { currentUser.achievements["連勝將軍"] = true; checkAndNotifyAchievement("連勝將軍"); }
            currentMoney = PRIZE_MONEY[questionsAnsweredCorrectlyInGame];
            if (questionsAnsweredCorrectlyInGame === SAFETY_NET_1_LEVEL) {
                safetyNet1Achieved = true; showMilestoneCelebration(`達到安全網: $${formatCurrency(PRIZE_MONEY[SAFETY_NET_1_LEVEL])}!`);
                if (currentUser && !currentUser.achievements["萬元戶"] && currentMoney >= 10000) { currentUser.achievements["萬元戶"] = true; checkAndNotifyAchievement("萬元戶");}
            }
            if (questionsAnsweredCorrectlyInGame === SAFETY_NET_2_LEVEL) {
                safetyNet2Achieved = true; showMilestoneCelebration(`達到安全網: $${formatCurrency(PRIZE_MONEY[SAFETY_NET_2_LEVEL])}!`);
                if (currentUser && !currentUser.achievements["十萬元戶"] && currentMoney >= 100000) { currentUser.achievements["十萬元戶"] = true; checkAndNotifyAchievement("十萬元戶");}
            }
            
            if (questionsAnsweredCorrectlyInGame === TOTAL_QUESTIONS_PER_GAME) {
                endGame('win');
            } else {
                nextQuestion(); // Only proceed to next question if game is not won
            }
        }
        function handleIncorrectAnswer() {
            currentStreakInGame = 0; let moneyWon = PRIZE_MONEY[0];
            if (safetyNet2Achieved) moneyWon = PRIZE_MONEY[SAFETY_NET_2_LEVEL];
            else if (safetyNet1Achieved) moneyWon = PRIZE_MONEY[SAFETY_NET_1_LEVEL];
            currentMoney = moneyWon; 
            endGame('loss');
        }

        function handleWalkAway(showGameOverScreen = true) {
            stopQuestionTimer();
            currentMoney = questionsAnsweredCorrectlyInGame > 0 ? PRIZE_MONEY[questionsAnsweredCorrectlyInGame] : PRIZE_MONEY[0];
            if (showGameOverScreen) {
                endGame('quit');
            } else {
                // This path is taken when quitting via logout/quit-to-menu and not showing immediate game over
                gameAttemptData.status = 'quit';
                gameAttemptData.questionsAnswered = questionsAnsweredCorrectlyInGame;
                gameAttemptData.moneyWon = currentMoney;
                if (currentUser) {
                    if (!currentUser.gameAttempts) currentUser.gameAttempts = []; // Ensure array exists
                    currentUser.gameAttempts.push(gameAttemptData);
                    const users = loadUsers(); users[currentUsername] = currentUser; saveUsers(users);
                }
                const gs = getLocalStorageItem(LS_GLOBAL_STATS_KEY, {});
                gs.totalMoneyAwarded = (gs.totalMoneyAwarded || 0) + currentMoney;
                // If not calling full endGame, ensure global game count is handled if necessary
                // However, endGame also increments totalGamesPlayed, so avoid double counting if called later.
                // For this specific path, we are bypassing the full endGame screen display.
                // The main game save happens via saveUsers(users) above.
                setLocalStorageItem(LS_GLOBAL_STATS_KEY, gs);
            }
        }

        function endGame(status) {
            stopQuestionTimer();
            gameAttemptData.status = status; gameAttemptData.questionsAnswered = questionsAnsweredCorrectlyInGame;
            gameAttemptData.moneyWon = currentMoney;
            if (currentUser) {
                if (!currentUser.gameAttempts) currentUser.gameAttempts = []; // Ensure array exists
                currentUser.gameAttempts.push(gameAttemptData);
                if (status === 'win') {
                    currentUser.achievements["百萬富翁"] = true; checkAndNotifyAchievement("百萬富翁");
                    const gs = getLocalStorageItem(LS_GLOBAL_STATS_KEY, {});
                    gs.totalMillionaires = (gs.totalMillionaires || 0) + 1; setLocalStorageItem(LS_GLOBAL_STATS_KEY, gs);
                }
                const users = loadUsers(); users[currentUsername] = currentUser; saveUsers(users);
            }
            const gs = getLocalStorageItem(LS_GLOBAL_STATS_KEY, {});
            gs.totalMoneyAwarded = (gs.totalMoneyAwarded || 0) + currentMoney;
            gs.totalGamesPlayed = (gs.totalGamesPlayed || 0) + 1;
            setLocalStorageItem(LS_GLOBAL_STATS_KEY, gs);

            gameOverTitle.textContent = status === 'win' ? "恭喜你成為百萬富翁!" : (status === 'quit' ? "明智的決定!" : "遊戲結束");
            let msg = "";
            if (status === 'win') msg = `你成功答對所有 ${TOTAL_QUESTIONS_PER_GAME} 條題目!`;
            else if (status === 'loss') msg = `你在第 ${currentQuestionNumber} 題答錯了。`;
            else if (status === 'quit') msg = `你選擇在第 ${currentQuestionNumber > 0 ? currentQuestionNumber : 1} 題後離開。`;
            else msg = "發生錯誤，遊戲已終止。";
            gameOverMessage.textContent = msg; gameOverWinnings.textContent = formatCurrency(currentMoney);
            showScreen('gameOver');
        }
        function showMilestoneCelebration(text) {
            milestoneText.textContent = text; milestoneCelebrationDiv.style.display = 'block';
            setTimeout(() => { milestoneCelebrationDiv.style.display = 'none'; }, 3000);
        }
        function checkAndNotifyAchievement(achievementName) {
            console.log(`成就解鎖: ${achievementName}`);
            showMilestoneCelebration(`成就解鎖: ${achievementName}!`);
        }

        // --- Lifelines ---
        function updateLifelineButtons() {
            lifeline5050Btn.disabled = currentLifelines.fiftyFifty; lifelinePhoneBtn.disabled = currentLifelines.phoneAFriend;
            lifelineAudienceBtn.disabled = currentLifelines.askTheAudience;
            lifeline5050Btn.style.opacity = currentLifelines.fiftyFifty ? '0.5' : '1';
            lifelinePhoneBtn.style.opacity = currentLifelines.phoneAFriend ? '0.5' : '1';
            lifelineAudienceBtn.style.opacity = currentLifelines.askTheAudience ? '0.5' : '1';
        }
        function useLifeline(type) {
            if (currentLifelines[type] || currentQuestionNumber === 0 || !gameQuestions[currentQuestionNumber-1]) return;
            currentLifelines[type] = true; gameAttemptData.lifelinesUsed[type] = true; updateLifelineButtons();
            const question = gameQuestions[currentQuestionNumber - 1]; const correctAnswerChar = question.correct.toUpperCase();
            const optionsChars = ['A', 'B', 'C', 'D']; const incorrectOptions = optionsChars.filter(opt => opt !== correctAnswerChar);
            if (type === 'fiftyFifty') {
                incorrectOptions.sort(() => 0.5 - Math.random()); const optionsToHide = [incorrectOptions[0], incorrectOptions[1]];
                optionButtons.forEach(btn => { if (optionsToHide.includes(btn.dataset.option)) { btn.style.visibility = 'hidden'; btn.disabled = true; }});
                if (currentUser) currentUser.lifelineStats.fiftyFifty.used++;
            } else if (type === 'phoneAFriend') {
                let suggested = (Math.random() < 0.75) ? correctAnswerChar : incorrectOptions[Math.floor(Math.random() * incorrectOptions.length)];
                alert(`致電好友結果：\n朋友認為答案是 ${suggested} (${question['option'+suggested]})`);
                if (currentUser) currentUser.lifelineStats.phoneAFriend.used++;
            } else if (type === 'askTheAudience') {
                let percentages = [0,0,0,0]; const correctIdx = correctAnswerChar.charCodeAt(0) - 'A'.charCodeAt(0);
                let baseCorrectPerc = 40; let visibleCount = optionButtons.filter(b => b.style.visibility !== 'hidden').length;
                if (visibleCount <= 2) baseCorrectPerc = 60;
                percentages[correctIdx] = Math.min(Math.floor(Math.random() * 31) + baseCorrectPerc, 85);
                let remainingPerc = 100 - percentages[correctIdx];
                const visibleOptsIdx = optionsChars.reduce((acc, opt, idx) => { if (optionButtons[idx].style.visibility !== 'hidden' && idx !== correctIdx) acc.push(idx); return acc; }, []).sort(() => 0.5 - Math.random());
                visibleOptsIdx.forEach((optIdx, i) => {
                    let share = (i === visibleOptsIdx.length - 1) ? remainingPerc : Math.min(Math.floor(Math.random() * (remainingPerc / (visibleOptsIdx.length - i) + 1)), remainingPerc);
                    percentages[optIdx] = share; remainingPerc -= share;
                });
                let currentSum = percentages.reduce((s, p, i) => s + (optionButtons[i].style.visibility !== 'hidden' ? p : 0), 0);
                if (currentSum !== 100 && visibleOptsIdx.length > 0) {
                    let diff = 100 - currentSum; let target = visibleOptsIdx.find(idx => percentages[idx] > 0) ?? correctIdx;
                    percentages[target] += diff;
                }
                let pollMsg = "觀眾投票結果:\n"; optionsChars.forEach((opt, idx) => { if (optionButtons[idx].style.visibility !== 'hidden') pollMsg += `${opt}: ${percentages[idx]}%\n`; });
                alert(pollMsg); if (currentUser) currentUser.lifelineStats.askTheAudience.used++;
            }
        }

        // --- Analytics & Display ---
        function displayProgressStats() {
            if (!currentUser) return;
            statsUsername.textContent = `用戶: ${currentUser.username}`; statsTotalGames.textContent = currentUser.gameAttempts.length;
            statsTotalWins.textContent = currentUser.gameAttempts.filter(g => g.status === 'win').length;
            const totalCorrectOverall = currentUser.gameAttempts.reduce((sum, g) => sum + g.questionsAnswered, 0);
            statsAvgCorrect.textContent = currentUser.gameAttempts.length > 0 ? (totalCorrectOverall / currentUser.gameAttempts.length).toFixed(1) : 'N/A';
            statsLongestStreak.textContent = currentUser.longestStreak || 0;
            statsCategoryTableBody.innerHTML = '';
            const allUserCategories = new Set(Object.keys(currentUser.progress).filter(k => k !== 'overallDifficulty' && k !== 'questionStats'));
            QUESTION_CATEGORIES.forEach(cat => allUserCategories.add(cat));
            allUserCategories.forEach(cat => {
                if (currentUser.progress[cat]) {
                    const catProg = currentUser.progress[cat]; let total=0, correct=0;
                    QUESTION_DIFFICULTIES.forEach(d => { total += (catProg[d]?.total || 0); correct += (catProg[d]?.correct || 0); });
                    const acc = total > 0 ? ((correct / total) * 100).toFixed(1) + '%' : 'N/A';
                    const r = statsCategoryTableBody.insertRow(); r.insertCell().textContent = cat; r.insertCell().textContent = total; r.insertCell().textContent = correct; r.insertCell().textContent = acc;
                }
            });
            statsDifficultyTableBody.innerHTML = '';
            QUESTION_DIFFICULTIES.forEach(diff => {
                const diffProg = currentUser.progress.overallDifficulty[diff] || {correct:0, total:0};
                const acc = diffProg.total > 0 ? ((diffProg.correct / diffProg.total) * 100).toFixed(1) + '%' : 'N/A';
                const r = statsDifficultyTableBody.insertRow(); r.insertCell().textContent = diff.charAt(0).toUpperCase() + diff.slice(1);
                r.insertCell().textContent = diffProg.total; r.insertCell().textContent = diffProg.correct; r.insertCell().textContent = acc;
            });
            updateRecommendations(); updateAchievementsDisplay(); showScreen('stats');
        }
        function updateRecommendations() {
            if (!currentUser || !currentUser.progress) { statsRecommendations.innerHTML = "<p>無足夠數據生成建議。</p>"; return; }
            const { progress } = currentUser; let html = ""; const weak = [], strong = [];
            const allCats = new Set(Object.keys(progress).filter(k => k !== 'overallDifficulty' && k !== 'questionStats'));
            QUESTION_CATEGORIES.forEach(cat => allCats.add(cat));
            allCats.forEach(cat => {
                if (progress[cat]) {
                    const catProg = progress[cat]; let total=0, correct=0;
                    QUESTION_DIFFICULTIES.forEach(d => { total += (catProg[d]?.total || 0); correct += (catProg[d]?.correct || 0); });
                    if (total >= MIN_ATTEMPTS_FOR_ADVICE) {
                        const acc = correct / total;
                        if (acc < WEAKNESS_ACCURACY_THRESHOLD) weak.push(cat); else if (acc >= STRENGTH_ACCURACY_THRESHOLD) strong.push(cat);
                    }
                }
            });
            if (strong.length > 0) html += `<p style="color: lightgreen;">做得好！您在以下類別表現出色: <strong>${strong.join('、')}</strong>。請繼續保持！</p>`;
            if (weak.length > 0) html += `<p style="color: orange;">建議加強練習 以下類別: <strong>${weak.join('、')}</strong>。</p>`;
            if (html === "") html = "<p>目前沒有特別的學習建議。請多進行遊戲以獲得更準確的分析！</p>";
            statsRecommendations.innerHTML = html;
        }
        function updateAchievementsDisplay() {
            if (!currentUser || !currentUser.achievements) return; statsAchievementsList.innerHTML = '';
            for (const achName in currentUser.achievements) {
                const li = document.createElement('li');
                li.textContent = `${achName}: ${currentUser.achievements[achName] ? '已達成 ✔' : '未達成 ❌'}`;
                li.style.color = currentUser.achievements[achName] ? 'lightgreen' : 'salmon';
                statsAchievementsList.appendChild(li);
            }
        }
        function displayGameHistory() {
            if (!currentUser) return; historyTableBody.innerHTML = '';
            currentUser.gameAttempts.slice().reverse().forEach(att => {
                const r = historyTableBody.insertRow(); r.insertCell().textContent = new Date(att.date).toLocaleString('zh-HK');
                let status = '';
                switch(att.status) {
                    case 'win': status = '勝利 (百萬富翁)'; break; case 'loss': status = '失敗'; break;
                    case 'quit': status = '放棄'; break; default: status = att.status;
                }
                r.insertCell().textContent = status; r.insertCell().textContent = att.questionsAnswered;
                r.insertCell().textContent = `$${formatCurrency(att.moneyWon)}`;
            });
            showScreen('history');
        }
        function displayLeaderboard() {
            const users = loadUsers(); const data = [];
            for (const name in users) {
                const user = users[name]; let maxW = 0, date = null;
                if (user.gameAttempts && user.gameAttempts.length > 0) {
                    user.gameAttempts.forEach(att => { if (att.moneyWon > maxW) { maxW = att.moneyWon; date = att.date; } });
                    if (user.gameAttempts.length > 0) data.push({ name: user.username, score: maxW, date: date });
                }
            }
            data.sort((a, b) => b.score - a.score); leaderboardTableBody.innerHTML = '';
            data.slice(0, 10).forEach((e, i) => {
                const r = leaderboardTableBody.insertRow(); r.insertCell().textContent = i + 1; r.insertCell().textContent = escapeHTML(e.name);
                r.insertCell().textContent = `$${formatCurrency(e.score)}`;
                r.insertCell().textContent = e.date ? new Date(e.date).toLocaleDateString('zh-HK') : 'N/A';
            });
            showScreen('leaderboard');
        }

        // --- Event Listeners ---
        window.addEventListener('beforeunload', function (e) {
            const gameScreenActive = screens.game.classList.contains('active');
            const inMiddleOfGame = currentQuestionNumber > 0 && currentQuestionNumber <= TOTAL_QUESTIONS_PER_GAME && gameQuestions.length > 0;
            if (gameScreenActive && inMiddleOfGame) {
                const confirmationMessage = '您正在進行遊戲中。如果您現在離開，當前問題的進度可能不會被儲存。建議您完成當前問題或使用「放棄」功能。如需備份所有遊戲數據，請使用主畫面上的「導出進度」功能。';
                e.returnValue = confirmationMessage; return confirmationMessage;
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const questionsLoaded = await loadQuestionsFromHostedCSV('questions.csv');
            registerLoginBtn.disabled = !questionsLoaded;
            if (!questionsLoaded) autoCsvStatusP.textContent = '錯誤：無法載入題目，請刷新或檢查網路。';
            showScreen('username');
            registerLoginBtn.addEventListener('click', handleRegisterLogin);
            newGameBtn.addEventListener('click', startNewGame);
            progressStatsBtn.addEventListener('click', displayProgressStats);
            gameHistoryBtn.addEventListener('click', displayGameHistory);
            leaderboardBtn.addEventListener('click', displayLeaderboard);
            logoutBtn.addEventListener('click', handleLogout);
            optionButtons.forEach(btn => { btn.addEventListener('click', () => { if (!btn.disabled) handleAnswer(btn.dataset.option); }); });
            walkAwayBtn.addEventListener('click', () => handleWalkAway(true)); 
            if (quitToMenuBtn) {
                quitToMenuBtn.addEventListener('click', () => {
                    confirmQuitAndOfferExport(() => {
                        showScreen('mainMenu');
                        currentQuestionNumber = 0; gameQuestions = []; 
                    });
                });
            }
            gameOverToMainMenuBtn.addEventListener('click', () => showScreen('mainMenu'));
            document.querySelectorAll('.back-to-menu-btn').forEach(btn => { btn.addEventListener('click', () => showScreen('mainMenu')); });
            if (exportDataBtn) exportDataBtn.addEventListener('click', exportGameData);
            if (importDataBtn) importDataBtn.addEventListener('click', () => { importFileInput.value = null; importFileInput.click(); });
            if (importFileInput) importFileInput.addEventListener('change', handleImportFile);
        });
    </script>


</body></html>