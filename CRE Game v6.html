<!DOCTYPE html><html lang="zh-HK"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRE 百萬富翁 - 中文運用</title>
    <style>
        /* Global Styles */
        body {
            font-family: Arial, 'Microsoft JhengHei', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #0c0c2c; /* Dark blue background */
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-size: 16px;
        }

        #app-container {
            width: 100%;
            max-width: 900px;
            min-height: 95vh;
            background-color: #1a1a4a; /* Slightly lighter blue */
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            flex-grow: 1;
        }

        .screen.active {
            display: flex;
        }

        h1, h2, h3 {
            color: #ffd700; /* Gold color for titles */
            text-align: center;
        }

        button {
            background-color: #4a4a7a;
            color: #fff;
            border: 2px solid #ffd700;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s, transform 0.2s;
        }

        button:hover {
            background-color: #6a6aa0;
            transform: translateY(-2px);
        }

        button:disabled {
            background-color: #333;
            color: #777;
            border-color: #555;
            cursor: not-allowed;
        }

        input[type="text"], input[type="file"] {
            padding: 10px;
            margin: 10px 0; 
            border-radius: 5px;
            border: 1px solid #ccc;
            width: calc(100% - 22px); 
            max-width: 300px;
            box-sizing: border-box;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            margin-bottom: 5px;
        }

        .spotlight-background {
            position: relative;
            overflow: hidden; 
        }
        .spotlight-background::before {
            content: '';
            position: absolute;
            top: -50%;
            left: 50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(255, 255, 220, 0.15) 0%, rgba(255, 255, 220, 0.05) 30%, transparent 60%);
            transform: translateX(-50%);
            animation: spotlight-anim 15s linear infinite;
            pointer-events: none;
        }

        @keyframes spotlight-anim {
            0% { transform: translateX(-50%) rotate(0deg); }
            100% { transform: translateX(-50%) rotate(360deg); }
        }

        #screen-game {
            justify-content: space-between;
        }

        .game-top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center; 
            width: 100%;
            padding: 0 10px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        .lifelines button {
            font-size: 0.9em;
            padding: 8px 12px;
        }
         .lifelines .lifeline-icon { 
            margin-right: 5px;
        }
        #question-timer {
            font-size: 1.2em;
            color: #ffd700;
            font-weight: bold;
        }

        .question-area {
            background-color: rgba(0,0,50,0.7);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            width: 95%;
            text-align: center;
            border: 1px solid #ffd700;
        }
        #question-context {
            font-size: 0.9em;
            margin-bottom: 10px;
            text-align: left;
            white-space: pre-wrap; 
            max-height: 150px;
            overflow-y: auto;
            border: 1px dashed #aaa;
            padding: 5px;
        }
        #question-text {
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        #difficulty-indicator {
            font-style: italic;
            color: #ccc;
            margin-bottom: 10px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
        }

        .options-grid button {
            background-color: #2a2a5a;
            width: 100%;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: flex-start; 
            padding-left: 20px; 
        }
         .options-grid button.flashing {
            animation: flash-yellow 1s infinite;
        }
        .options-grid button.correct {
            background-color: green !important;
            animation: none !important;
        }
        .options-grid button.incorrect {
            background-color: red !important;
            animation: none !important;
        }
        .options-grid button.selected-for-audience {
            border: 2px solid cyan;
        }

        @keyframes flash-yellow {
            0%, 100% { background-color: #ffd700; color: #0c0c2c; }
            50% { background-color: #4a4a7a; color: #fff; }
        }

        .money-ladder {
            width: 200px;
            padding: 10px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 5px;
            margin-left:10px; 
        }
        .money-ladder h3 {
            margin-top: 0;
            font-size: 1.1em;
        }
        .money-ladder ul {
            padding: 0;
            margin: 0;
            text-align: right;
        }
        .money-ladder li {
            padding: 3px 5px;
            border-radius: 3px;
            margin-bottom: 2px;
            font-size: 0.9em;
            color: #ccc;
        }
        .money-ladder li.current-level {
            background-color: #ffd700;
            color: #0c0c2c;
            font-weight: bold;
        }
        .money-ladder li.safety-net {
            color: #ffeb99; 
            font-weight: bold;
        }
        .money-ladder li.achieved-safety-net {
            background-color: #b8860b; 
            color: white;
        }

        #explanation-content {
            background-color: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            max-width: 80%;
            text-align: left;
            white-space: pre-wrap;
        }

        .stats-content-wrapper {
            max-height: 60vh; 
            overflow-y: auto;
            width: 100%;
            padding-right: 10px; 
            box-sizing: border-box;
            margin-bottom: 10px; 
        }

        .stats-table, .history-table, .leaderboard-table {
            width: 90%;
            margin-top: 15px;
            border-collapse: collapse;
        }
        .stats-table th, .stats-table td,
        .history-table th, .history-table td,
        .leaderboard-table th, .leaderboard-table td {
            border: 1px solid #ffd700;
            padding: 8px;
            text-align: left;
        }
        .stats-table th, .history-table th, .leaderboard-table th {
            background-color: #4a4a7a;
        }

        @media (max-width: 768px) {
            #app-container {
                padding: 10px;
                min-height: 100vh; 
            }
            .options-grid {
                grid-template-columns: 1fr; 
            }
            .game-screen-layout { 
                flex-direction: column-reverse; 
                align-items: center;
            }
            .money-ladder {
                width: 90%;
                margin-left: 0;
                margin-bottom: 15px; 
                text-align: center;
            }
            .money-ladder ul {
                text-align: center; 
            }
            .money-ladder li {
                display: inline-block; 
                margin: 2px;
            }
            .lifelines {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
            .lifelines button {
                margin: 5px;
            }
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.5em; }
            #question-text { font-size: 1.1em; }
            .game-top-bar {
                flex-direction: column; 
                align-items: center;
            }
            #question-timer { margin-top: 10px; }
            .stats-content-wrapper {
                max-height: 70vh; 
            }
        }

        .milestone-celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 215, 0, 0.9); 
            color: #0c0c2c;
            padding: 30px;
            border-radius: 10px;
            font-size: 2em;
            text-align: center;
            z-index: 1000;
            display: none; 
            animation: fadeInOut 3s ease-in-out;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20%, 80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

    </style>
</head>
<body class="spotlight-background">
    <div id="app-container">
        <!-- Username Screen -->
        <div id="screen-username" class="screen active">
            <h1>CRE 百萬富翁 - 中文運用</h1>
            <h2>歡迎! 請輸入用戶名 (3-20 字元)</h2>
            <input type="text" id="username-input" placeholder="用戶名">
            <button id="register-login-btn">註冊 / 登入</button>
            <p id="username-error" style="color: red;"></p>
            <p id="auto-csv-status" style="margin-top: 10px;"></p> <!-- For auto CSV load status -->

            <div id="data-management-area" style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 15px; width:100%; text-align:center;">
                <h3>遊戲進度管理</h3>
                <button id="export-data-btn" style="background-color: #306754;">導出此用戶進度</button>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
                <button id="import-data-btn" style="background-color: #673030;">導入用戶進度</button>
                <p id="data-management-status" style="margin-top: 10px;"></p>
            </div>

            <!-- CSV Management Area Removed for GitHub Pages Version -->
            <!-- 
            <div id="csv-management-area" style="margin-top: 30px; border-top: 1px solid #ffd700; padding-top: 20px; width:100%; text-align:center;">
                <h3>題目管理</h3>
                <p>請上傳題目 CSV 檔案 (UTF-8 編碼):</p>
                <input type="file" id="csv-file-input" accept=".csv">
                <button id="load-csv-btn">載入題目</button>
                <button id="download-sample-csv-btn">下載範例 CSV</button>
                <p id="csv-status"></p>
            </div>
             -->
        </div>

        <!-- Main Menu Screen -->
        <div id="screen-main-menu" class="screen">
            <h1>主目錄</h1>
            <h2 id="welcome-user-text"></h2>
            <button id="new-game-btn">開始新遊戲</button>
            <button id="progress-stats-btn">進度統計</button>
            <button id="game-history-btn">遊戲記錄</button>
            <button id="leaderboard-btn">排行榜</button>
            <button id="logout-btn">登出</button>
        </div>

        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="game-top-bar">
                <div class="lifelines">
                    <button id="lifeline-5050" data-used="false"><span class="lifeline-icon">½</span> 50:50</button>
                    <button id="lifeline-phone" data-used="false"><span class="lifeline-icon">📞</span> 致電好友</button>
                    <button id="lifeline-audience" data-used="false"><span class="lifeline-icon">📊</span> 觀眾投票</button>
                </div>
                <div id="question-timer">01:00</div>
                <div id="current-question-info">問題 1 / 15</div>
            </div>

            <div class="game-screen-layout" style="display: flex; width: 100%; flex-grow: 1;">
                <div class="question-options-area" style="flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <div class="question-area">
                        <div id="difficulty-indicator"></div>
                        <div id="question-context"></div>
                        <div id="question-text"></div>
                    </div>
                    <div class="options-grid">
                        <button id="optionA-btn" data-option="A"></button>
                        <button id="optionB-btn" data-option="B"></button>
                        <button id="optionC-btn" data-option="C"></button>
                        <button id="optionD-btn" data-option="D"></button>
                    </div>
                </div>
                <div class="money-ladder" id="money-ladder-display">
                    <h3>獎金階梯</h3>
                    <ul></ul>
                </div>
            </div>

            <div class="game-controls" style="margin-top: auto;">
                <button id="walk-away-btn">放棄並取走獎金</button>
            </div>
        </div>

        <!-- Explanation Screen -->
        <div id="screen-explanation" class="screen">
            <h2 id="explanation-title"></h2>
            <p id="explanation-question"></p>
            <p>你的答案: <span id="explanation-your-answer"></span></p>
            <p>正確答案: <span id="explanation-correct-answer"></span></p>
            <h3>解釋:</h3>
            <div id="explanation-content"></div>
            <button id="explanation-continue-btn">繼續</button>
        </div>

        <!-- Game Over Screen -->
        <div id="screen-game-over" class="screen">
            <h1 id="game-over-title">遊戲結束</h1>
            <p id="game-over-message"></p>
            <p>你獲得的獎金: $<span id="game-over-winnings"></span></p>
            <button id="game-over-tomainmenu-btn">返回主目錄</button>
        </div>

        <!-- Progress Stats Screen -->
        <div id="screen-stats" class="screen">
            <h1>進度統計</h1>
            <div class="stats-content-wrapper">
                <h3 id="stats-username"></h3>
                <h4>整體表現:</h4>
                <p>總遊戲次數: <span id="stats-total-games"></span></p>
                <p>總勝出次數 (百萬富翁): <span id="stats-total-wins"></span></p>
                <p>平均每局答對題數: <span id="stats-avg-correct"></span></p>
                <p>最長連勝紀錄: <span id="stats-longest-streak"></span></p>

                <h4>按類別表現:</h4>
                <table id="stats-category-table" class="stats-table">
                    <thead><tr><th>類別</th><th>已嘗試</th><th>答對</th><th>正確率</th></tr></thead>
                    <tbody></tbody>
                </table>

                <h4>按難度表現:</h4>
                <table id="stats-difficulty-table" class="stats-table">
                    <thead><tr><th>難度</th><th>已嘗試</th><th>答對</th><th>正確率</th></tr></thead>
                    <tbody></tbody>
                </table>
                
                <h4>學習建議:</h4>
                <p id="stats-recommendations"></p>

                <h4>成就:</h4>
                <ul id="stats-achievements-list"></ul>
            </div>
            <button class="back-to-menu-btn">返回主目錄</button>
        </div>

        <!-- Game History Screen -->
        <div id="screen-history" class="screen">
            <h1>遊戲記錄</h1>
            <div class="stats-content-wrapper"> 
                <table id="history-table" class="history-table">
                    <thead><tr><th>日期</th><th>狀態</th><th>答對題數</th><th>獎金</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <button class="back-to-menu-btn">返回主目錄</button>
        </div>

        <!-- Leaderboard Screen -->
        <div id="screen-leaderboard" class="screen">
            <h1>排行榜 (最高獎金)</h1>
            <div class="stats-content-wrapper">
                <table id="leaderboard-table" class="leaderboard-table">
                    <thead><tr><th>排名</th><th>用戶名</th><th>獎金</th><th>日期</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <button class="back-to-menu-btn">返回主目錄</button>
        </div>

        <!-- Milestone Celebration Popup -->
        <div id="milestone-celebration" class="milestone-celebration">
            <p id="milestone-text"></p>
        </div>

    </div>

    <script>
        // --- Constants and Global State ---
        const LS_USERS_KEY = 'crem_users';
        // const LS_QUESTIONS_KEY = 'crem_questions'; // No longer storing questions in LS for hosted version
        const LS_GLOBAL_STATS_KEY = 'crem_globalStats';

        const PRIZE_MONEY = [0, 1000, 2000, 3000, 5000, 10000, 20000, 40000, 80000, 160000, 320000, 450000, 600000, 750000, 850000, 1000000];
        const SAFETY_NET_1_LEVEL = 5; 
        const SAFETY_NET_2_LEVEL = 10; 
        const TOTAL_QUESTIONS_PER_GAME = 15;
        const QUESTION_TIME_LIMIT = 60; 

        const QUESTION_CATEGORIES = ["片段/語段閱讀", "片段閱讀", "字詞辨識", "句子辨析", "詞句運用"];
        const QUESTION_DIFFICULTIES = ["easy", "medium", "hard"];


        let allQuestions = []; // Will be populated by fetching CSV
        let currentUser = null;
        let currentUsername = '';

        // Game State
        let gameQuestions = [];
        let currentQuestionNumber = 0;
        let currentMoney = 0;
        let currentLifelines = {};
        let questionsAnsweredCorrectlyInGame = 0;
        let safetyNet1Achieved = false;
        let safetyNet2Achieved = false;
        let currentStreakInGame = 0;
        let gameAttemptData = {};
        let questionStartTime;
        let questionTimerInterval = null; 
        let timeLeft = QUESTION_TIME_LIMIT; 


        // --- DOM Elements ---
        const screens = {
            username: document.getElementById('screen-username'),
            mainMenu: document.getElementById('screen-main-menu'),
            game: document.getElementById('screen-game'),
            explanation: document.getElementById('screen-explanation'),
            gameOver: document.getElementById('screen-game-over'),
            stats: document.getElementById('screen-stats'),
            history: document.getElementById('screen-history'),
            leaderboard: document.getElementById('screen-leaderboard'),
        };

        // Username Screen
        const usernameInput = document.getElementById('username-input');
        const registerLoginBtn = document.getElementById('register-login-btn');
        const usernameError = document.getElementById('username-error');
        // CSV File Input Elements are removed
        // const csvFileInput = document.getElementById('csv-file-input');
        // const loadCsvBtn = document.getElementById('load-csv-btn');
        // const downloadSampleCsvBtn = document.getElementById('download-sample-csv-btn');
        // const csvStatus = document.getElementById('csv-status'); // Will be replaced by a mock or console logging

        // Data Management Elements
        const exportDataBtn = document.getElementById('export-data-btn');
        const importFileInput = document.getElementById('import-file-input');
        const importDataBtn = document.getElementById('import-data-btn');
        const dataManagementStatus = document.getElementById('data-management-status');


        // Main Menu Screen
        const welcomeUserText = document.getElementById('welcome-user-text');
        const newGameBtn = document.getElementById('new-game-btn');
        const progressStatsBtn = document.getElementById('progress-stats-btn');
        const gameHistoryBtn = document.getElementById('game-history-btn');
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const logoutBtn = document.getElementById('logout-btn');

        // Game Screen (elements remain the same)
        const lifeline5050Btn = document.getElementById('lifeline-5050');
        const lifelinePhoneBtn = document.getElementById('lifeline-phone');
        const lifelineAudienceBtn = document.getElementById('lifeline-audience');
        const currentQuestionInfo = document.getElementById('current-question-info');
        const questionTimerDisplay = document.getElementById('question-timer'); 
        const difficultyIndicator = document.getElementById('difficulty-indicator');
        const questionContext = document.getElementById('question-context');
        const questionText = document.getElementById('question-text');
        const optionABtn = document.getElementById('optionA-btn');
        const optionBBtn = document.getElementById('optionB-btn');
        const optionCBtn = document.getElementById('optionC-btn');
        const optionDBtn = document.getElementById('optionD-btn');
        const optionButtons = [optionABtn, optionBBtn, optionCBtn, optionDBtn];
        const moneyLadderDisplay = document.getElementById('money-ladder-display').querySelector('ul');
        const walkAwayBtn = document.getElementById('walk-away-btn');

        // Explanation Screen (elements remain the same)
        const explanationTitle = document.getElementById('explanation-title');
        const explanationQuestion = document.getElementById('explanation-question');
        const explanationYourAnswer = document.getElementById('explanation-your-answer');
        const explanationCorrectAnswer = document.getElementById('explanation-correct-answer');
        const explanationContent = document.getElementById('explanation-content');
        const explanationContinueBtn = document.getElementById('explanation-continue-btn');

        // Game Over Screen (elements remain the same)
        const gameOverTitle = document.getElementById('game-over-title');
        const gameOverMessage = document.getElementById('game-over-message');
        const gameOverWinnings = document.getElementById('game-over-winnings');
        const gameOverToMainMenuBtn = document.getElementById('game-over-tomainmenu-btn');

        // Stats, History, Leaderboard Screens (elements remain the same)
        const statsUsername = document.getElementById('stats-username');
        const statsTotalGames = document.getElementById('stats-total-games');
        const statsTotalWins = document.getElementById('stats-total-wins');
        const statsAvgCorrect = document.getElementById('stats-avg-correct');
        const statsLongestStreak = document.getElementById('stats-longest-streak');
        const statsCategoryTableBody = document.getElementById('stats-category-table').querySelector('tbody');
        const statsDifficultyTableBody = document.getElementById('stats-difficulty-table').querySelector('tbody');
        const statsRecommendations = document.getElementById('stats-recommendations');
        const statsAchievementsList = document.getElementById('stats-achievements-list');
        const historyTableBody = document.getElementById('history-table').querySelector('tbody');
        const leaderboardTableBody = document.getElementById('leaderboard-table').querySelector('tbody');
        const milestoneCelebrationDiv = document.getElementById('milestone-celebration');
        const milestoneText = document.getElementById('milestone-text');


        // --- Utility Functions (remain the same) ---
        function showScreen(screenId) {
            for (const key in screens) {
                screens[key].classList.remove('active');
            }
            if (screens[screenId]) {
                screens[screenId].classList.add('active');
            } else {
                console.error("畫面未找到:", screenId);
            }
        }
        function getLocalStorageItem(key, defaultValue = {}) { /* ... */ }
        function setLocalStorageItem(key, value) { /* ... */ }
        function formatCurrency(amount) { /* ... */ }
        function formatTime(seconds) { /* ... */ }
        function getDifficultyForQuestion(qNum) { /* ... */ }

        // --- User Management (remains the same) ---
        function loadUsers() { /* ... */ }
        function saveUsers(users) { /* ... */ }
        function initializeUser(username) { /* ... */ }
        function initializeAchievements() { /* ... */ }
        // handleRegisterLogin will be slightly adjusted
        function handleLogout() { /* ... */ }


        // --- CSV Management (Modified for GitHub Pages) ---
        const csvStatus = { // Mock csvStatus or use console/alert
            textContent: '',
            style: { color: '' },
            log: function(message, type = 'info') {
                console.log(`CSV 狀態 (${type}): ${message}`);
                this.textContent = message;
                let color = 'blue';
                if (type === 'error') color = 'red';
                else if (type === 'success') color = 'green';
                this.style.color = color;
                
                const autoCsvStatusP = document.getElementById('auto-csv-status');
                if (autoCsvStatusP) {
                    autoCsvStatusP.textContent = message;
                    autoCsvStatusP.style.color = color;
                }
            }
        };

        function parseCSV(csvText) {
            if (csvText.charCodeAt(0) === 0xFEFF) { // BOM
                csvText = csvText.substring(1);
            }
            const lines = csvText.split(/\r\n|\n/);
            if (lines.length === 0) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            const questions = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue;
                const fields = [];
                let currentField = '';
                let inQuotes = false;
                let quoteChar = '';
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (!inQuotes && (char === '"' || char === "'")) {
                        inQuotes = true;
                        quoteChar = char;
                    } else if (inQuotes && char === quoteChar) {
                        if (j + 1 < line.length && line[j + 1] === quoteChar) {
                            currentField += quoteChar;
                            j++;
                        } else {
                            inQuotes = false;
                        }
                    } else if (char === ',' && !inQuotes) {
                        fields.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                fields.push(currentField.trim());

                if (fields.length !== headers.length) {
                    console.warn(`跳過格式錯誤的 CSV 行 ${i + 1} (預期 ${headers.length} 欄位，得到 ${fields.length}): ${lines[i]}`);
                    csvStatus.log(`警告: CSV 第 ${i+1} 行欄位數量不符，已跳過。`, 'error');
                    continue;
                }
                const question = {};
                headers.forEach((header, index) => {
                    question[header] = fields[index];
                });
                if (!question.id || !question.category || !question.difficulty || !question.question || !question.optionA || !question.optionB || !question.optionC || !question.optionD || !question.correct) {
                    console.warn(`Skipping incomplete CSV line ${i+1}: Missing essential fields for ID ${question.id}.`);
                    csvStatus.log(`警告: CSV 第 ${i+1} 行 (ID: ${question.id}) 缺少必要欄位，已跳過。`, 'error');
                    continue;
                }
                if (question.difficulty && !QUESTION_DIFFICULTIES.includes(question.difficulty.toLowerCase())) {
                    csvStatus.log(`警告: CSV 第 ${i+1} 行 (ID: ${question.id}) 難度 "${question.difficulty}" 無效。`, 'error');
                    continue;
                }
                questions.push(question);
            }
            return questions;
        }

        async function loadQuestionsFromHostedCSV(filePath) {
            try {
                csvStatus.log('正在從伺服器載入題目...', 'info');
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`無法獲取題目檔案: ${response.status} ${response.statusText}`);
                }
                const csvText = await response.text();
                const parsedQuestions = parseCSV(csvText);

                if (parsedQuestions.length > 0) {
                    allQuestions = parsedQuestions;
                    csvStatus.log(`成功載入 ${allQuestions.length} 條題目。遊戲已準備就緒！`, 'success');
                    return true;
                } else {
                    csvStatus.log('題目檔案為空或格式不正確。無法開始遊戲。', 'error');
                    return false;
                }
            } catch (error) {
                csvStatus.log(`載入題目時出錯: ${error.message}。無法開始遊戲。`, 'error');
                console.error("載入題目 CSV 時出錯:", error);
                return false;
            }
        }
        
        // --- Data Import/Export Functions (remain the same) ---
        function exportGameData() { /* ... */ }
        function handleImportFile(event) { /* ... */ }

        // --- Game Logic (remains largely the same) ---
        function startQuestionTimer() { /* ... */ }
        function stopQuestionTimer() { /* ... */ }
        function selectGameQuestions() { /* ... */ }
        function startNewGame() { /* ... */ }
        function updateMoneyLadder() { /* ... */ }
        function displayQuestion() { /* ... */ }
        function nextQuestion() { /* ... */ }
        function handleAnswer(selectedOption) { /* ... */ }
        function showExplanationScreen(question, selectedOption, isCorrect) { /* ... */ }
        function handleCorrectAnswer() { /* ... */ }
        function handleIncorrectAnswer() { /* ... */ }
        function handleWalkAway() { /* ... */ }
        function endGame(status) { /* ... */ }
        function showMilestoneCelebration(text) { /* ... */ }
        function checkAndNotifyAchievement(achievementName) { /* ... */ }
        
        // --- Lifelines (remain the same) ---
        function updateLifelineButtons() { /* ... */ }
        function useLifeline(type) { /* ... */ }

        // --- Analytics & Display (remain the same) ---
        function displayProgressStats() { /* ... */ }
        function displayGameHistory() { /* ... */ }
        function displayLeaderboard() { /* ... */ }


        // --- Adjusted handleRegisterLogin ---
        function handleRegisterLogin() {
            const username = usernameInput.value.trim();
            usernameError.textContent = '';

            if (username.length < 3 || username.length > 20) {
                usernameError.textContent = '用戶名必須為 3-20 個字元。';
                return;
            }
            if (!/^[a-zA-Z0-9_]+$/.test(username)) { 
                usernameError.textContent = '用戶名只能包含字母、數字和底線。';
                return;
            }

            if (allQuestions.length === 0) {
                // This message implies automatic loading failed.
                csvStatus.log('錯誤：遊戲題目未能成功載入，無法開始遊戲。', 'error'); 
                alert('錯誤：遊戲題目未能成功載入，無法開始遊戲。請刷新頁面或稍後再試。');
                registerLoginBtn.disabled = true; // Disable login if questions aren't loaded
                return;
            }

            const users = loadUsers();
            if (!users[username]) {
                users[username] = initializeUser(username);
                saveUsers(users);
                alert(`用戶 ${username} 註冊成功!`);
            }
            currentUser = users[username];
            currentUsername = username;
            welcomeUserText.textContent = `歡迎, ${currentUsername}!`;
            showScreen('mainMenu');
        }


        // --- Event Listeners (Modified) ---
        document.addEventListener('DOMContentLoaded', async () => {
            const questionsLoaded = await loadQuestionsFromHostedCSV('questions.csv'); // Ensure this path is correct for your GitHub Pages setup

            if (!questionsLoaded) {
                // Disable game start if questions failed to load
                registerLoginBtn.disabled = true;
                // The error message is already handled by csvStatus.log within loadQuestionsFromHostedCSV
                // You could add an additional alert here if desired:
                // alert("嚴重錯誤：無法載入遊戲題目。請檢查控制台或聯繫管理員。");
            } else {
                registerLoginBtn.disabled = false;
            }

            showScreen('username'); 
            
            registerLoginBtn.addEventListener('click', handleRegisterLogin);
            // Removed listeners for manual CSV loading

            newGameBtn.addEventListener('click', startNewGame);
            progressStatsBtn.addEventListener('click', displayProgressStats);
            gameHistoryBtn.addEventListener('click', displayGameHistory);
            leaderboardBtn.addEventListener('click', displayLeaderboard);
            logoutBtn.addEventListener('click', handleLogout);

            optionButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!btn.disabled) { 
                        handleAnswer(btn.dataset.option)
                    }
                });
            });
            
            walkAwayBtn.addEventListener('click', handleWalkAway);

            lifeline5050Btn.addEventListener('click', () => useLifeline('fiftyFifty'));
            lifelinePhoneBtn.addEventListener('click', () => useLifeline('phoneAFriend'));
            lifelineAudienceBtn.addEventListener('click', () => useLifeline('askTheAudience'));

            gameOverToMainMenuBtn.addEventListener('click', () => showScreen('mainMenu'));
            
            document.querySelectorAll('.back-to-menu-btn').forEach(btn => {
                btn.addEventListener('click', () => showScreen('mainMenu'));
            });

            if (exportDataBtn) {
                exportDataBtn.addEventListener('click', exportGameData);
            }
            if (importDataBtn) {
                importDataBtn.addEventListener('click', () => {
                    importFileInput.value = null; 
                    importFileInput.click(); 
                });
            }
            if (importFileInput) {
                importFileInput.addEventListener('change', handleImportFile);
            }
        });

        // --- Re-pasting the functions that were shortened with /* ... */ for completeness ---
        // Utility Functions
        function getLocalStorageItem(key, defaultValue = {}) {
            const item = localStorage.getItem(key);
            try {
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.warn(`解析 localStorage 項目 ${key} 時出錯:`, e);
                return defaultValue;
            }
        }

        function setLocalStorageItem(key, value) {
            localStorage.setItem(key, JSON.stringify(value));
        }

        function formatCurrency(amount) {
            return amount.toLocaleString();
        }
        
        function formatTime(seconds) { 
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function getDifficultyForQuestion(qNum) { 
            if (qNum <= 5) return 'easy';
            if (qNum <= 10) return 'medium';
            return 'hard';
        }

        // User Management
        function loadUsers() {
            return getLocalStorageItem(LS_USERS_KEY, {});
        }

        function saveUsers(users) {
            setLocalStorageItem(LS_USERS_KEY, users);
        }

        function initializeUser(username) {
            const userProgress = {
                overallDifficulty: { easy: {correct:0, total:0}, medium: {correct:0, total:0}, hard: {correct:0, total:0} },
            };
            QUESTION_CATEGORIES.forEach(cat => { 
                userProgress[cat] = { easy: {correct:0, total:0}, medium: {correct:0, total:0}, hard: {correct:0, total:0} };
            });

            return {
                username: username,
                gameAttempts: [],
                progress: userProgress,
                achievements: initializeAchievements(),
                lifelineStats: {
                    fiftyFifty: { used: 0, successfulUse: 0 },
                    phoneAFriend: { used: 0, successfulUse: 0 },
                    askTheAudience: { used: 0, successfulUse: 0 }
                },
                longestStreak: 0,
                preferences: {} 
            };
        }
        
        function initializeAchievements() {
            return {
                "新手上路": false, 
                "初試啼聲": false, 
                "萬元戶": false,   
                "十萬元戶": false, 
                "百萬富翁": false, 
                "智囊團": false,  
                "連勝將軍": false, 
                "時間管理大師": false, 
            };
        }

        function handleLogout() {
            currentUser = null;
            currentUsername = '';
            usernameInput.value = '';
            showScreen('username');
        }

        // Data Import/Export
        function exportGameData() {
            dataManagementStatus.textContent = '';
            const usernameToExport = usernameInput.value.trim(); 

            if (!usernameToExport) {
                dataManagementStatus.textContent = "請在用戶名欄位中輸入要導出的用戶名。";
                dataManagementStatus.style.color = "orange";
                return;
            }

            const allUsers = loadUsers(); 
            const userDataToExport = allUsers[usernameToExport]; 

            if (!userDataToExport) {
                dataManagementStatus.textContent = `在本地存儲中找不到用戶 "${usernameToExport}" 的數據。`;
                dataManagementStatus.style.color = "red";
                return;
            }

            const dataToExport = {
                appVersion: "CRE_Millionaire_User_1.0",
                exportedAt: new Date().toISOString(),
                username: usernameToExport, 
                userData: userDataToExport, 
            };

            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement("a");
            const filename = `cre_millionaire_progress_${usernameToExport}.json`;

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                dataManagementStatus.textContent = `用戶 ${usernameToExport} 的遊戲進度已導出為 ${filename}。`;
                dataManagementStatus.style.color = 'green';
            } else {
                dataManagementStatus.textContent = "您的瀏覽器不支持自動下載。";
                dataManagementStatus.style.color = 'red';
            }
        }

        function handleImportFile(event) {
            dataManagementStatus.textContent = ''; 
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedContainer = JSON.parse(e.target.result);
                        if (!importedContainer || typeof importedContainer !== 'object' ||
                            !importedContainer.userData || !importedContainer.username) {
                            throw new Error("無效的用戶存檔檔案格式：缺少 'userData' 或 'username'。");
                        }
                        if (importedContainer.appVersion !== "CRE_Millionaire_User_1.0") {
                            console.warn("導入的用戶存檔檔案版本 (" + (importedContainer.appVersion || "未知") + ") 可能不相容或為舊格式。");
                        }
                        const importedUsername = importedContainer.username;
                        const importedUserData = importedContainer.userData;
                        const allUsersData = loadUsers();
                        allUsersData[importedUsername] = importedUserData;
                        saveUsers(allUsersData);
                        dataManagementStatus.textContent = `用戶 ${importedUsername} 的遊戲進度已成功導入！`;
                        dataManagementStatus.style.color = 'green';
                        if (!currentUser || currentUsername === importedUsername) {
                            currentUsername = importedUsername;
                            currentUser = importedUserData; 
                            if (screens.mainMenu.classList.contains('active') || screens.username.classList.contains('active')) {
                                 welcomeUserText.textContent = `歡迎, ${currentUsername}! (進度已導入)`;
                                 if (screens.username.classList.contains('active')) {
                                    showScreen('mainMenu');
                                 }
                            }
                        } else {
                            alert(`用戶 ${importedUsername} 的數據已導入。\n您當前登入為 ${currentUsername}。\n如要使用 ${importedUsername} 的數據，請先登出，然後以 ${importedUsername} 登入。`);
                        }
                        if (!currentUser && allUsersData[importedUsername]) {
                            usernameInput.value = importedUsername; 
                        }
                        importFileInput.value = null; 
                    } catch (error) {
                        dataManagementStatus.textContent = `導入用戶存檔檔案時出錯: ${error.message}`;
                        dataManagementStatus.style.color = 'red';
                        console.error("導入用戶遊戲數據時出錯:", error);
                        importFileInput.value = null; 
                    }
                };
                reader.onerror = function() {
                    dataManagementStatus.textContent = '讀取檔案失敗。';
                    dataManagementStatus.style.color = 'red';
                    importFileInput.value = null; 
                };
                reader.readAsText(file);
            } else {
                dataManagementStatus.textContent = "未選擇檔案。";
                dataManagementStatus.style.color = "orange";
            }
        }

        // Game Logic
        function startQuestionTimer() {
            stopQuestionTimer(); 
            timeLeft = QUESTION_TIME_LIMIT;
            questionTimerDisplay.textContent = formatTime(timeLeft);
            questionTimerDisplay.style.color = '#ffd700'; 
            questionTimerInterval = setInterval(() => {
                timeLeft--;
                questionTimerDisplay.textContent = formatTime(timeLeft);
                if (timeLeft <= 10 && timeLeft > 0) {
                    questionTimerDisplay.style.color = 'red'; 
                }
                if (timeLeft <= 0) {
                    stopQuestionTimer();
                    alert("時間到！");
                    optionButtons.forEach(btn => btn.disabled = true); 
                    walkAwayBtn.disabled = true;
                    const question = gameQuestions[currentQuestionNumber - 1];
                    gameAttemptData.answers.push({
                        questionId: question.id,
                        selected: 'TIMEOUT', 
                        correct: question.correct.toUpperCase(),
                        timeTaken: QUESTION_TIME_LIMIT 
                    });
                    showExplanationScreen(question, 'TIMEOUT', false); 
                }
            }, 1000);
        }

        function stopQuestionTimer() {
            if (questionTimerInterval) {
                clearInterval(questionTimerInterval);
                questionTimerInterval = null;
            }
        }

        function selectGameQuestions() {
            const allEasyQs = allQuestions.filter(q => q.difficulty && q.difficulty.toLowerCase() === 'easy');
            const allMediumQs = allQuestions.filter(q => q.difficulty && q.difficulty.toLowerCase() === 'medium');
            const allHardQs = allQuestions.filter(q => q.difficulty && q.difficulty.toLowerCase() === 'hard');
            if (allEasyQs.length < 5 || allMediumQs.length < 5 || allHardQs.length < 5) {
                alert("題目數量不足以開始遊戲 (每種難度至少需要5條)。");
                return false;
            }
            const selectedQuestionsForThisGame = [];
            const usedQuestionIdsInThisGame = new Set();
            function pickNRandomUniqueQuestions(sourceArray, count, currentUsedIdsSet) {
                const availableFromSource = sourceArray.filter(q => !currentUsedIdsSet.has(q.id));
                if (availableFromSource.length < count) return []; 
                const shuffled = [...availableFromSource]; 
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                const pickedQuestions = shuffled.slice(0, count);
                pickedQuestions.forEach(q => currentUsedIdsSet.add(q.id)); 
                return pickedQuestions;
            }
            const chosenEasy = pickNRandomUniqueQuestions(allEasyQs, 5, usedQuestionIdsInThisGame);
            if (chosenEasy.length < 5) { alert("無法選取足夠的 Easy 題目。"); return false; }
            selectedQuestionsForThisGame.push(...chosenEasy);
            const chosenMedium = pickNRandomUniqueQuestions(allMediumQs, 5, usedQuestionIdsInThisGame);
            if (chosenMedium.length < 5) { alert("無法選取足夠的 Medium 題目。"); return false; }
            selectedQuestionsForThisGame.push(...chosenMedium);
            const chosenHard = pickNRandomUniqueQuestions(allHardQs, 5, usedQuestionIdsInThisGame);
            if (chosenHard.length < 5) { alert("無法選取足夠的 Hard 題目。"); return false; }
            selectedQuestionsForThisGame.push(...chosenHard);
            if (selectedQuestionsForThisGame.length !== TOTAL_QUESTIONS_PER_GAME || usedQuestionIdsInThisGame.size !== TOTAL_QUESTIONS_PER_GAME) {
                alert(`選題錯誤：最終未能選出 ${TOTAL_QUESTIONS_PER_GAME} 條不重複的題目。`);
                return false;
            }
            gameQuestions = selectedQuestionsForThisGame; 
            return true;
        }

        function startNewGame() {
            if (!selectGameQuestions()) {
                showScreen('mainMenu'); 
                return;
            }
            currentQuestionNumber = 0; 
            currentMoney = 0;
            questionsAnsweredCorrectlyInGame = 0;
            safetyNet1Achieved = false;
            safetyNet2Achieved = false;
            currentStreakInGame = 0;
            currentLifelines = { fiftyFifty: true, phoneAFriend: true, askTheAudience: true };
            updateLifelineButtons();
            gameAttemptData = {
                id: `game_${Date.now()}`,
                date: new Date().toISOString(),
                status: 'quit', 
                questionsAnswered: 0,
                moneyWon: 0,
                lifelinesUsed: { fiftyFifty: false, phoneAFriend: false, askTheAudience: false },
                answers: [] 
            };
            const globalStats = getLocalStorageItem(LS_GLOBAL_STATS_KEY, { totalGamesPlayed: 0, totalMillionaires: 0, totalMoneyAwarded: 0 });
            globalStats.totalGamesPlayed = (globalStats.totalGamesPlayed || 0) + 1;
            setLocalStorageItem(LS_GLOBAL_STATS_KEY, globalStats);
            if (currentUser && !currentUser.achievements["新手上路"]) {
                currentUser.achievements["新手上路"] = true;
                checkAndNotifyAchievement("新手上路");
            }
            nextQuestion();
            showScreen('game');
        }

        function updateMoneyLadder() {
            moneyLadderDisplay.innerHTML = '';
            for (let i = TOTAL_QUESTIONS_PER_GAME; i >= 1; i--) {
                const li = document.createElement('li');
                li.textContent = `Q${i}: $${formatCurrency(PRIZE_MONEY[i])}`;
                if (i === questionsAnsweredCorrectlyInGame + 1 && currentQuestionNumber <= TOTAL_QUESTIONS_PER_GAME) { 
                    li.classList.add('current-level');
                }
                if (i === SAFETY_NET_1_LEVEL || i === SAFETY_NET_2_LEVEL) {
                    li.classList.add('safety-net');
                    if ((i === SAFETY_NET_1_LEVEL && safetyNet1Achieved) || (i === SAFETY_NET_2_LEVEL && safetyNet2Achieved)) {
                         li.classList.add('achieved-safety-net');
                    }
                }
                moneyLadderDisplay.appendChild(li);
            }
        }
        
        function displayQuestion() {
            const q = gameQuestions[currentQuestionNumber - 1]; 
            if (!q) { endGame('error'); return; }
            questionStartTime = Date.now();
            startQuestionTimer(); 
            currentQuestionInfo.textContent = `問題 ${currentQuestionNumber} / ${TOTAL_QUESTIONS_PER_GAME}`;
            difficultyIndicator.textContent = `難度: ${q.difficulty}`;
            questionContext.textContent = q.context || '';
            questionContext.style.display = q.context ? 'block' : 'none';
            questionText.textContent = q.question;
            const options = [q.optionA, q.optionB, q.optionC, q.optionD];
            optionButtons.forEach((btn, index) => {
                btn.innerHTML = `<span style="color: #ffd700; margin-right: 8px;">${String.fromCharCode(65 + index)}:</span> ${options[index]}`;
                btn.disabled = false;
                btn.style.visibility = 'visible';
                btn.classList.remove('correct', 'incorrect', 'flashing', 'selected-for-audience');
            });
            updateMoneyLadder();
            walkAwayBtn.disabled = (currentQuestionNumber === 1 && questionsAnsweredCorrectlyInGame === 0); 
        }

        function nextQuestion() {
            currentQuestionNumber++;
            if (currentQuestionNumber > TOTAL_QUESTIONS_PER_GAME) {
                endGame('win'); 
            } else {
                displayQuestion();
            }
        }

        function handleAnswer(selectedOption) { 
            stopQuestionTimer(); 
            optionButtons.forEach(btn => btn.disabled = true); 
            walkAwayBtn.disabled = true;
            const question = gameQuestions[currentQuestionNumber - 1];
            const correctAnswer = question.correct.toUpperCase();
            const timeTaken = (Date.now() - questionStartTime) / 1000; 
            gameAttemptData.answers.push({
                questionId: question.id,
                selected: selectedOption,
                correct: correctAnswer,
                timeTaken: timeTaken
            });
            let isCorrect = selectedOption === correctAnswer;
            optionButtons.forEach(btn => {
                if (btn.dataset.option === selectedOption) {
                    btn.classList.add(isCorrect ? 'correct' : 'incorrect');
                }
                if (btn.dataset.option === correctAnswer) {
                    if(!isCorrect) btn.classList.add('flashing');
                    else btn.classList.add('correct'); 
                }
            });
            if (currentUser) {
                const cat = question.category; 
                const diff = question.difficulty.toLowerCase();
                if (!currentUser.progress[cat]) { 
                    currentUser.progress[cat] = { easy: {correct:0, total:0}, medium: {correct:0, total:0}, hard: {correct:0, total:0} };
                }
                 if (!currentUser.progress[cat][diff]) { 
                     currentUser.progress[cat][diff] = {correct:0, total:0};
                }
                currentUser.progress[cat][diff].total++;
                currentUser.progress.overallDifficulty[diff].total++;
                if (isCorrect) {
                    currentUser.progress[cat][diff].correct++;
                    currentUser.progress.overallDifficulty[diff].correct++;
                    if (timeLeft > 0 && !currentUser.achievements["時間管理大師"]) { 
                        currentUser.achievements["時間管理大師"] = true;
                        checkAndNotifyAchievement("時間管理大師");
                    }
                }
            }
            setTimeout(() => {
                showExplanationScreen(question, selectedOption, isCorrect);
            }, 2000); 
        }

        function showExplanationScreen(question, selectedOption, isCorrect) {
            stopQuestionTimer(); 
            explanationTitle.textContent = isCorrect ? "答對了!" : (selectedOption === 'TIMEOUT' ? "時間到了!" : "答錯了!");
            explanationTitle.style.color = isCorrect ? "lightgreen" : "salmon";
            explanationQuestion.textContent = `問題: ${question.question}`;
            explanationYourAnswer.textContent = selectedOption === 'TIMEOUT' ? '未作答 (時間到)' : `${selectedOption} (${question['option'+selectedOption]})`;
            explanationCorrectAnswer.textContent = `${question.correct} (${question['option'+question.correct]})`;
            explanationContent.innerHTML = question.explanation ? question.explanation.replace(/\\n/g, '<br>') : "沒有提供解釋。"; 
            explanationContinueBtn.onclick = () => {
                if (isCorrect) {
                    handleCorrectAnswer();
                } else {
                    handleIncorrectAnswer(); 
                }
            };
            showScreen('explanation');
        }

        function handleCorrectAnswer() {
            questionsAnsweredCorrectlyInGame++;
            currentStreakInGame++;
            if (currentUser && currentStreakInGame > currentUser.longestStreak) {
                currentUser.longestStreak = currentStreakInGame;
            }
            if (currentUser && !currentUser.achievements["初試啼聲"]) {
                currentUser.achievements["初試啼聲"] = true;
                checkAndNotifyAchievement("初試啼聲");
            }
             if (currentUser && currentStreakInGame >= 5 && !currentUser.achievements["連勝將軍"]) {
                currentUser.achievements["連勝將軍"] = true;
                checkAndNotifyAchievement("連勝將軍");
            }
            currentMoney = PRIZE_MONEY[questionsAnsweredCorrectlyInGame];
            if (questionsAnsweredCorrectlyInGame === SAFETY_NET_1_LEVEL) {
                safetyNet1Achieved = true;
                showMilestoneCelebration(`恭喜! 你已達到第一個安全網: $${formatCurrency(PRIZE_MONEY[SAFETY_NET_1_LEVEL])}!`);
                 if (currentUser && !currentUser.achievements["萬元戶"]) {
                    currentUser.achievements["萬元戶"] = true;
                    checkAndNotifyAchievement("萬元戶");
                }
            }
            if (questionsAnsweredCorrectlyInGame === SAFETY_NET_2_LEVEL) {
                safetyNet2Achieved = true;
                showMilestoneCelebration(`恭喜! 你已達到第二個安全網: $${formatCurrency(PRIZE_MONEY[SAFETY_NET_2_LEVEL])}!`);
                 if (currentUser && !currentUser.achievements["十萬元戶"]) {
                    currentUser.achievements["十萬元戶"] = true;
                    checkAndNotifyAchievement("十萬元戶");
                }
            }
            if (questionsAnsweredCorrectlyInGame === TOTAL_QUESTIONS_PER_GAME) {
                endGame('win');
            } else {
                nextQuestion();
                showScreen('game');
            }
        }

        function handleIncorrectAnswer() {
            stopQuestionTimer(); 
            currentStreakInGame = 0;
            let moneyWon = 0;
            if (safetyNet2Achieved) moneyWon = PRIZE_MONEY[SAFETY_NET_2_LEVEL];
            else if (safetyNet1Achieved) moneyWon = PRIZE_MONEY[SAFETY_NET_1_LEVEL];
            else moneyWon = 0; 
            currentMoney = moneyWon;
            endGame('loss');
        }
        
        function handleWalkAway() {
            stopQuestionTimer(); 
            let moneyWon = questionsAnsweredCorrectlyInGame > 0 ? PRIZE_MONEY[questionsAnsweredCorrectlyInGame] : 0;
            currentMoney = moneyWon;
            endGame('quit');
        }

        function endGame(status) { 
            stopQuestionTimer(); 
            gameAttemptData.status = status;
            gameAttemptData.questionsAnswered = questionsAnsweredCorrectlyInGame;
            gameAttemptData.moneyWon = currentMoney;
            if (currentUser) {
                currentUser.gameAttempts.push(gameAttemptData);
                if (status === 'win') {
                    currentUser.achievements["百萬富翁"] = true;
                    checkAndNotifyAchievement("百萬富翁");
                    const globalStats = getLocalStorageItem(LS_GLOBAL_STATS_KEY, {});
                    globalStats.totalMillionaires = (globalStats.totalMillionaires || 0) + 1;
                    setLocalStorageItem(LS_GLOBAL_STATS_KEY, globalStats);
                }
                const users = loadUsers();
                users[currentUsername] = currentUser;
                saveUsers(users);
            }
            const globalStats = getLocalStorageItem(LS_GLOBAL_STATS_KEY, {});
            globalStats.totalMoneyAwarded = (globalStats.totalMoneyAwarded || 0) + currentMoney;
            setLocalStorageItem(LS_GLOBAL_STATS_KEY, globalStats);
            gameOverTitle.textContent = status === 'win' ? "恭喜你成為百萬富翁!" : (status === 'quit' ? "明智的決定!" : "遊戲結束");
            let message = "";
            if (status === 'win') message = `你成功答對所有 ${TOTAL_QUESTIONS_PER_GAME} 條題目!`;
            else if (status === 'loss') message = `你在第 ${currentQuestionNumber} 題答錯了。`;
            else if (status === 'quit') message = `你選擇在第 ${currentQuestionNumber > 0 ? currentQuestionNumber : 1} 題後離開。`; 
            else message = "發生錯誤，遊戲已終止。";
            gameOverMessage.textContent = message;
            gameOverWinnings.textContent = formatCurrency(currentMoney);
            showScreen('gameOver');
        }
        
        function showMilestoneCelebration(text) {
            milestoneText.textContent = text;
            milestoneCelebrationDiv.style.display = 'block';
            setTimeout(() => {
                milestoneCelebrationDiv.style.display = 'none';
            }, 3000); 
        }

        function checkAndNotifyAchievement(achievementName) {
            console.log(`成就解鎖: ${achievementName}`);
            showMilestoneCelebration(`成就解鎖: ${achievementName}!`);
        }

        // Lifelines
        function updateLifelineButtons() {
            lifeline5050Btn.disabled = !currentLifelines.fiftyFifty;
            lifelinePhoneBtn.disabled = !currentLifelines.phoneAFriend;
            lifelineAudienceBtn.disabled = !currentLifelines.askTheAudience;
            lifeline5050Btn.style.opacity = currentLifelines.fiftyFifty ? '1' : '0.5';
            lifelinePhoneBtn.style.opacity = currentLifelines.phoneAFriend ? '1' : '0.5';
            lifelineAudienceBtn.style.opacity = currentLifelines.askTheAudience ? '1' : '0.5';
        }
        
        function useLifeline(type) {
            if (!currentLifelines[type] || currentQuestionNumber === 0 || !gameQuestions[currentQuestionNumber-1]) return; 
            currentLifelines[type] = false;
            gameAttemptData.lifelinesUsed[type] = true;
            updateLifelineButtons();
            const question = gameQuestions[currentQuestionNumber - 1];
            const correctAnswerChar = question.correct.toUpperCase(); 
            const optionsChars = ['A', 'B', 'C', 'D'];
            const incorrectOptions = optionsChars.filter(opt => opt !== correctAnswerChar);

            if (type === 'fiftyFifty') {
                incorrectOptions.sort(() => 0.5 - Math.random());
                const optionsToHide = [incorrectOptions[0], incorrectOptions[1]];
                optionButtons.forEach(btn => {
                    if (optionsToHide.includes(btn.dataset.option)) {
                        btn.style.visibility = 'hidden';
                        btn.disabled = true;
                    }
                });
                if (currentUser) currentUser.lifelineStats.fiftyFifty.used++;
            } else if (type === 'phoneAFriend') {
                let suggestedOption = (Math.random() < 0.75) ? correctAnswerChar : incorrectOptions[Math.floor(Math.random() * incorrectOptions.length)];
                alert(`致電好友結果：\n你的朋友認為答案是 ${suggestedOption} (${question['option'+suggestedOption]})`);
                if (currentUser) currentUser.lifelineStats.phoneAFriend.used++;
            } else if (type === 'askTheAudience') {
                let percentages = [0,0,0,0];
                const correctIndex = correctAnswerChar.charCodeAt(0) - 'A'.charCodeAt(0);
                let baseCorrectPercentage = 40;
                let otherOptionsCount = optionButtons.filter(btn => btn.style.visibility !== 'hidden').length;
                if (otherOptionsCount <= 2) baseCorrectPercentage = 60; 
                percentages[correctIndex] = Math.min(Math.floor(Math.random() * 31) + baseCorrectPercentage, 85); 
                let remainingPercentage = 100 - percentages[correctIndex];
                const visibleOptionsIndices = optionsChars.reduce((acc, opt, index) => {
                    if (optionButtons[index].style.visibility !== 'hidden' && index !== correctIndex) acc.push(index);
                    return acc;
                }, []).sort(() => 0.5 - Math.random());
                visibleOptionsIndices.forEach((optIndex, i) => {
                    let share = (i === visibleOptionsIndices.length - 1) ? remainingPercentage : Math.min(Math.floor(Math.random() * (remainingPercentage / (visibleOptionsIndices.length - i) + 1)), remainingPercentage);
                    percentages[optIndex] = share;
                    remainingPercentage -= share;
                });
                let currentSum = percentages.reduce((sum, p, i) => sum + (optionButtons[i].style.visibility !== 'hidden' ? p : 0), 0);
                if (currentSum !== 100 && visibleOptionsIndices.length > 0) {
                    let diffToAdjust = 100 - currentSum;
                    let targetAdjust = visibleOptionsIndices.find(idx => percentages[idx] > 0) ?? correctIndex;
                    percentages[targetAdjust] += diffToAdjust;
                }
                let pollResultText = "觀眾投票結果:\n";
                optionsChars.forEach((opt, index) => {
                    if (optionButtons[index].style.visibility !== 'hidden') pollResultText += `${opt}: ${percentages[index]}%\n`;
                });
                alert(pollResultText);
                if (currentUser) currentUser.lifelineStats.askTheAudience.used++;
            }
        }

        // Analytics & Display
        function displayProgressStats() {
            if (!currentUser) return;
            statsUsername.textContent = `用戶: ${currentUser.username}`;
            statsTotalGames.textContent = currentUser.gameAttempts.length;
            statsTotalWins.textContent = currentUser.gameAttempts.filter(g => g.status === 'win').length;
            const totalCorrect = currentUser.gameAttempts.reduce((sum, g) => sum + g.questionsAnswered, 0);
            statsAvgCorrect.textContent = currentUser.gameAttempts.length > 0 ? (totalCorrect / currentUser.gameAttempts.length).toFixed(1) : 'N/A';
            statsLongestStreak.textContent = currentUser.longestStreak || 0;
            statsCategoryTableBody.innerHTML = '';
            const displayedCategories = new Set(); 
            QUESTION_CATEGORIES.forEach(cat => {
                if (currentUser.progress[cat]) {
                    const catProgress = currentUser.progress[cat];
                    let catTotal = 0, catCorrect = 0;
                    QUESTION_DIFFICULTIES.forEach(diff => {
                        catTotal += (catProgress[diff] ? catProgress[diff].total : 0);
                        catCorrect += (catProgress[diff] ? catProgress[diff].correct : 0);
                    });
                    const accuracy = catTotal > 0 ? ((catCorrect / catTotal) * 100).toFixed(1) + '%' : 'N/A';
                    const row = statsCategoryTableBody.insertRow();
                    row.insertCell().textContent = cat;
                    row.insertCell().textContent = catTotal;
                    row.insertCell().textContent = catCorrect;
                    row.insertCell().textContent = accuracy;
                    displayedCategories.add(cat);
                }
            });
            for (const cat in currentUser.progress) {
                if (cat !== 'overallDifficulty' && !QUESTION_CATEGORIES.includes(cat) && currentUser.progress[cat]) { // Handle categories not in the predefined list
                    if (!displayedCategories.has(cat)) {
                        const catProgress = currentUser.progress[cat];
                        let catTotal = 0, catCorrect = 0;
                        QUESTION_DIFFICULTIES.forEach(diff => {
                            catTotal += (catProgress[diff] ? catProgress[diff].total : 0);
                            catCorrect += (catProgress[diff] ? catProgress[diff].correct : 0);
                        });
                        const accuracy = catTotal > 0 ? ((catCorrect / catTotal) * 100).toFixed(1) + '%' : 'N/A';
                        const row = statsCategoryTableBody.insertRow();
                        row.insertCell().textContent = cat;
                        row.insertCell().textContent = catTotal;
                        row.insertCell().textContent = catCorrect;
                        row.insertCell().textContent = accuracy;
                    }
                }
            }
            statsDifficultyTableBody.innerHTML = '';
            QUESTION_DIFFICULTIES.forEach(diff => {
                const diffProgress = currentUser.progress.overallDifficulty[diff] || {correct:0, total:0};
                const accuracy = diffProgress.total > 0 ? ((diffProgress.correct / diffProgress.total) * 100).toFixed(1) + '%' : 'N/A';
                const row = statsDifficultyTableBody.insertRow();
                row.insertCell().textContent = diff.charAt(0).toUpperCase() + diff.slice(1); 
                row.insertCell().textContent = diffProgress.total;
                row.insertCell().textContent = diffProgress.correct;
                row.insertCell().textContent = accuracy;
            });
            let recommendations = "沒有特別建議。";
            const weakCategories = [];
            for (const cat in currentUser.progress) {
                if (cat === 'overallDifficulty') continue;
                const catProgress = currentUser.progress[cat];
                let catTotal = 0, catCorrect = 0;
                 QUESTION_DIFFICULTIES.forEach(diff => {
                    catTotal += (catProgress[diff] ? catProgress[diff].total : 0);
                    catCorrect += (catProgress[diff] ? catProgress[diff].correct : 0);
                });
                if (catTotal > 5 && (catCorrect / catTotal) < 0.6) { 
                    weakCategories.push(cat);
                }
            }
            if (weakCategories.length > 0) {
                recommendations = `建議加強練習以下類別: ${weakCategories.join(', ')}。`;
            }
            statsRecommendations.textContent = recommendations;
            statsAchievementsList.innerHTML = '';
            for (const achName in currentUser.achievements) {
                const li = document.createElement('li');
                li.textContent = `${achName}: ${currentUser.achievements[achName] ? '已達成 ✔' : '未達成 ❌'}`;
                li.style.color = currentUser.achievements[achName] ? 'lightgreen' : 'salmon';
                statsAchievementsList.appendChild(li);
            }
            showScreen('stats');
        }

        function displayGameHistory() {
            if (!currentUser) return;
            historyTableBody.innerHTML = '';
            currentUser.gameAttempts.slice().reverse().forEach(attempt => { 
                const row = historyTableBody.insertRow();
                row.insertCell().textContent = new Date(attempt.date).toLocaleString('zh-HK');
                let statusText = '';
                switch(attempt.status) {
                    case 'win': statusText = '勝利 (百萬富翁)'; break;
                    case 'loss': statusText = '失敗'; break;
                    case 'quit': statusText = '放棄'; break;
                    default: statusText = attempt.status;
                }
                row.insertCell().textContent = statusText;
                row.insertCell().textContent = attempt.questionsAnswered;
                row.insertCell().textContent = `$${formatCurrency(attempt.moneyWon)}`;
            });
            showScreen('history');
        }

        function displayLeaderboard() {
            const users = loadUsers();
            const leaderboardData = [];
            for (const username in users) {
                const user = users[username];
                let maxWinnings = 0;
                let dateOfMaxWinnings = null;
                if (user.gameAttempts && user.gameAttempts.length > 0) {
                    user.gameAttempts.forEach(attempt => {
                        if (attempt.moneyWon > maxWinnings) {
                            maxWinnings = attempt.moneyWon;
                            dateOfMaxWinnings = attempt.date;
                        }
                    });
                     if (user.gameAttempts.length > 0) {
                        leaderboardData.push({ username: user.username, score: maxWinnings, date: dateOfMaxWinnings });
                     }
                } else if (users.hasOwnProperty(username)) { 
                     leaderboardData.push({ username: user.username, score: 0, date: null });
                }
            }
            leaderboardData.sort((a, b) => b.score - a.score); 
            leaderboardTableBody.innerHTML = '';
            leaderboardData.slice(0, 10).forEach((entry, index) => { 
                const row = leaderboardTableBody.insertRow();
                row.insertCell().textContent = index + 1;
                row.insertCell().textContent = entry.username;
                row.insertCell().textContent = `$${formatCurrency(entry.score)}`;
                row.insertCell().textContent = entry.date ? new Date(entry.date).toLocaleDateString('zh-HK') : 'N/A';
            });
            showScreen('leaderboard');
        }

    </script>


</body></html>